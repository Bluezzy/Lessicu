!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).LichessPuzzle=e()}}((function(){return function e(t,n,o){function r(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(i)return i(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[s]={exports:{}};t[s][0].call(l.exports,(function(e){return r(t[s][1][e]||e)}),l,l.exports,e,t,n,o)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r}({1:[function(e,t,n){function o(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var r,i=function(){function e(){}var t=e.prototype;return t.unwrap=function(e,t){var o=this._chain((function(t){return n.Result.ok(e?e(t):t)}),(function(e){return t?n.Result.ok(t(e)):n.Result.err(e)}));if(o.isErr)throw o.error;return o.value},t.map=function(e,t){return this._chain((function(t){return n.Result.ok(e(t))}),(function(e){return n.Result.err(t?t(e):e)}))},t.chain=function(e,t){return this._chain(e,t||function(e){return n.Result.err(e)})},e}(),s=function(e){function t(t){var n;return(n=e.call(this)||this).value=t,n.isOk=!0,n.isErr=!1,n}return o(t,e),t.prototype._chain=function(e,t){return e(this.value)},t}(i),a=function(e){function t(t){var n;return(n=e.call(this)||this).error=t,n.isOk=!1,n.isErr=!0,n}return o(t,e),t.prototype._chain=function(e,t){return t(this.error)},t}(i);(r=n.Result||(n.Result={})).ok=function(e){return new s(e)},r.err=function(e){return new a(e)},r.all=function(e){if(Array.isArray(e)){for(var t=[],n=0;n<e.length;n++){var o=e[n];if(o.isErr)return o;t.push(o.value)}return r.ok(t)}for(var i={},s=Object.keys(e),a=0;a<s.length;a++){var c=e[s[a]];if(c.isErr)return c;i[s[a]]=c.value}return r.ok(i)}},{}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util");function r(e,t){const n=e(t);return t.dom.redraw(),n}function i(e,t){return{key:e,pos:o.key2pos(e),piece:t}}function s(e){for(let t in e)return!1;return!0}n.anim=function(e,t){return t.animation.enabled?function(e,t){const n=Object.assign({},t.pieces),r=e(t),a=function(e,t){const n={},r=[],s={},a=[],c=[],u={};let l,d,h,p;for(h in e)u[h]=i(h,e[h]);for(const f of o.allKeys)l=t.pieces[f],d=u[f],l?d?o.samePiece(l,d.piece)||(a.push(d),c.push(i(f,l))):c.push(i(f,l)):d&&a.push(d);return c.forEach(e=>{d=function(e,t){return t.sort((t,n)=>o.distanceSq(e.pos,t.pos)-o.distanceSq(e.pos,n.pos))[0]}(e,a.filter(t=>o.samePiece(e.piece,t.piece))),d&&(p=[d.pos[0]-e.pos[0],d.pos[1]-e.pos[1]],n[e.key]=p.concat(p),r.push(d.key))}),a.forEach(e=>{o.containsX(r,e.key)||(s[e.key]=e.piece)}),{anims:n,fadings:s}}(n,t);if(s(a.anims)&&s(a.fadings))t.dom.redraw();else{const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:a},e||function e(t,n){const o=t.animation.current;if(void 0===o)return void(t.dom.destroyed||t.dom.redrawNow());const r=1-(n-o.start)*o.frequency;if(r<=0)t.animation.current=void 0,t.dom.redrawNow();else{const n=(i=r)<.5?4*i*i*i:(i-1)*(2*i-2)*(2*i-2)+1;for(let e in o.plan.anims){const t=o.plan.anims[e];t[2]=t[0]*n,t[3]=t[1]*n}t.dom.redrawNow(!0),requestAnimationFrame((n=performance.now())=>e(t,n))}var i}(t,performance.now())}return r}(e,t):r(e,t)},n.render=r},{"./util":18}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./board"),r=e("./fen"),i=e("./config"),s=e("./anim"),a=e("./drag"),c=e("./explosion");n.start=function(e,t){function n(){o.toggleOrientation(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),(t.fen?s.anim:s.render)(e=>i.configure(e,t),e)},state:e,getFen:()=>r.write(e.pieces),toggleOrientation:n,setPieces(t){s.anim(e=>o.setPieces(e,t),e)},selectSquare(t,n){t?s.anim(e=>o.selectSquare(e,t,n),e):e.selected&&(o.unselect(e),e.dom.redraw())},move(t,n){s.anim(e=>o.baseMove(e,t,n),e)},newPiece(t,n){s.anim(e=>o.baseNewPiece(e,t,n),e)},playPremove(){if(e.premovable.current){if(s.anim(o.playPremove,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=o.playPredrop(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){s.render(o.unsetPremove,e)},cancelPredrop(){s.render(o.unsetPredrop,e)},cancelMove(){s.render(e=>{o.cancelMove(e),a.cancel(e)},e)},stop(){s.render(e=>{o.stop(e),a.cancel(e)},e)},explode(t){c.default(e,t)},setAutoShapes(t){s.render(e=>e.drawable.autoShapes=t,e)},setShapes(t){s.render(e=>e.drawable.shapes=t,e)},getKeyAtDomPos:t=>o.getKeyAtDomPos(t,o.whitePov(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,o){a.dragNewPiece(e,t,n,o)},destroy(){o.stop(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}},{"./anim":2,"./board":4,"./config":6,"./drag":7,"./explosion":11,"./fen":12}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util"),r=e("./premove");function i(e,...t){e&&setTimeout(()=>e(...t),1)}function s(e){e.premovable.current&&(e.premovable.current=void 0,i(e.premovable.events.unset))}function a(e){const t=e.predroppable;t.current&&(t.current=void 0,i(t.events.unset))}function c(e,t,n){const r=e.pieces[t],s=e.pieces[n];if(t===n||!r)return!1;const a=s&&s.color!==r.color?s:void 0;return n==e.selected&&p(e),i(e.events.move,t,n,a),function(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces[t];if(!r||"king"!==r.role)return!1;const i=o.key2pos(t);if(5!==i[0])return!1;if(1!==i[1]&&8!==i[1])return!1;const s=o.key2pos(n);let a,c,u;if(7===s[0]||8===s[0])a=o.pos2key([8,i[1]]),c=o.pos2key([6,i[1]]),u=o.pos2key([7,i[1]]);else{if(3!==s[0]&&1!==s[0])return!1;a=o.pos2key([1,i[1]]),c=o.pos2key([4,i[1]]),u=o.pos2key([3,i[1]])}const l=e.pieces[a];return!(!l||"rook"!==l.role)&&(delete e.pieces[t],delete e.pieces[a],e.pieces[u]=r,e.pieces[c]=l,!0)}(e,t,n)||(e.pieces[n]=r,delete e.pieces[t]),e.lastMove=[t,n],e.check=void 0,i(e.events.change),a||!0}function u(e,t,n,r){if(e.pieces[n]){if(!r)return!1;delete e.pieces[n]}return i(e.events.dropNewPiece,t,n),e.pieces[n]=t,e.lastMove=[n],e.check=void 0,i(e.events.change),e.movable.dests=void 0,e.turnColor=o.opposite(e.turnColor),!0}function l(e,t,n){const r=c(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=o.opposite(e.turnColor),e.animation.current=void 0),r}function d(e,t,n){if(m(e,t,n)){const o=l(e,t,n);if(o){const r=e.hold.stop();p(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==o&&(s.captured=o),i(e.movable.events.after,t,n,s),!0}}else if(function(e,t,n){return t!==n&&v(e,t)&&o.containsX(r.default(e.pieces,t,e.premovable.castle),n)}(e,t,n))return function(e,t,n,o){a(e),e.premovable.current=[t,n],i(e.premovable.events.set,t,n,o)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),p(e),!0;return p(e),!1}function h(e,t){e.selected=t,v(e,t)?e.premovable.dests=r.default(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function p(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function f(e,t){const n=e.pieces[t];return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function m(e,t,n){return t!==n&&f(e,t)&&(e.movable.free||!!e.movable.dests&&o.containsX(e.movable.dests[t],n))}function v(e,t){const n=e.pieces[t];return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function g(e){s(e),a(e),p(e)}n.callUserFunction=i,n.toggleOrientation=function(e){e.orientation=o.opposite(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0},n.reset=function(e){e.lastMove=void 0,p(e),s(e),a(e)},n.setPieces=function(e,t){for(let n in t){const o=t[n];o?e.pieces[n]=o:delete e.pieces[n]}},n.setCheck=function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(let n in e.pieces)"king"===e.pieces[n].role&&e.pieces[n].color===t&&(e.check=n)},n.unsetPremove=s,n.unsetPredrop=a,n.baseMove=c,n.baseNewPiece=u,n.userMove=d,n.dropNewPiece=function(e,t,n,o){if(function(e,t,n){const o=e.pieces[t];return!!o&&n&&(t===n||!e.pieces[n])&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}(e,t,n)||o){const r=e.pieces[t];delete e.pieces[t],u(e,r,n,o),i(e.movable.events.afterNewPiece,r.role,n,{predrop:!1})}else!function(e,t,n){const o=e.pieces[t],r=e.pieces[n];return!!o&&n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===o.color&&e.turnColor!==o.color}(e,t,n)?(s(e),a(e)):function(e,t,n){s(e),e.predroppable.current={role:t,key:n},i(e.predroppable.events.set,t,n)}(e,e.pieces[t].role,n);delete e.pieces[t],p(e)},n.selectSquare=function(e,t,n){if(i(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return p(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&d(e,e.selected,t))return void(e.stats.dragged=!1)}(f(e,t)||v(e,t))&&(h(e,t),e.hold.start())},n.setSelected=h,n.unselect=p,n.canMove=m,n.isDraggable=function(e,t){const n=e.pieces[t];return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))},n.playPremove=function(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],o=t[1];let r=!1;if(m(e,n,o)){const t=l(e,n,o);if(t){const s={premove:!0};!0!==t&&(s.captured=t),i(e.movable.events.after,n,o,s),r=!0}}return s(e),r},n.playPredrop=function(e,t){let n=e.predroppable.current,o=!1;if(!n)return!1;if(t(n)){u(e,{role:n.role,color:e.movable.color},n.key)&&(i(e.movable.events.afterNewPiece,n.role,n.key,{predrop:!0}),o=!0)}return a(e),o},n.cancelMove=g,n.stop=function(e){e.movable.color=e.movable.dests=e.animation.current=void 0,g(e)},n.getKeyAtDomPos=function(e,t,n){let r=Math.ceil((e[0]-n.left)/n.width*8);t||(r=9-r);let i=Math.ceil(8-(e[1]-n.top)/n.height*8);return t||(i=9-i),r>0&&r<9&&i>0&&i<9?o.pos2key([r,i]):void 0},n.whitePov=function(e){return"white"===e.orientation}},{"./premove":13,"./util":18}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./api"),r=e("./config"),i=e("./state"),s=e("./wrap"),a=e("./events"),c=e("./render"),u=e("./svg"),l=e("./util");function d(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}n.Chessground=function(e,t){const n=i.defaults();function h(){let t=n.dom&&n.dom.unbind;const o=n.viewOnly&&!n.drawable.visible,r=s.default(e,n,o),i=l.memo(()=>r.board.getBoundingClientRect()),p=e=>{c.default(n),!e&&r.svg&&u.renderSvg(n,r.svg)};n.dom={elements:r,bounds:i,redraw:d(p),redrawNow:p,unbind:t,relative:o},n.drawable.prevSvgHash="",p(!1),a.bindBoard(n),t||(n.dom.unbind=a.bindDocument(n,h)),n.events.insert&&n.events.insert(r)}return r.configure(n,t||{}),h(),o.start(n,h)}},{"./api":3,"./config":6,"./events":10,"./render":14,"./state":15,"./svg":16,"./util":18,"./wrap":19}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./board"),r=e("./fen");function i(e){return"object"==typeof e}n.configure=function(e,t){if(t.movable&&t.movable.dests&&(e.movable.dests=void 0),function e(t,n){for(let o in n)i(t[o])&&i(n[o])?e(t[o],n[o]):t[o]=n[o]}(e,t),t.fen&&(e.pieces=r.read(t.fen),e.drawable.shapes=[]),t.hasOwnProperty("check")&&o.setCheck(e,t.check||!1),t.hasOwnProperty("lastMove")&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&o.setSelected(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?1:8,n="e"+t,o=e.movable.dests[n],r=e.pieces[n];if(!o||!r||"king"!==r.role)return;e.movable.dests[n]=o.filter(e=>!(e==="a"+t&&-1!==o.indexOf("c"+t)||e==="h"+t&&-1!==o.indexOf("g"+t)))}}},{"./board":4,"./fen":12}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./board"),r=e("./util"),i=e("./draw"),s=e("./anim");function a(e,t){const n=o.whitePov(e),i=e.dom.bounds(),s=Math.pow(i.width/8,2);for(let o in e.pieces){const e=d(o,n,i),a=[e.left+e.width/2,e.top+e.height/2];if(r.distanceSq(a,t)<=s)return!0}return!1}function c(e){requestAnimationFrame(()=>{const t=e.draggable.current;if(!t)return;e.animation.current&&e.animation.current.plan.anims[t.orig]&&(e.animation.current=void 0);const n=e.pieces[t.orig];if(n&&r.samePiece(n,t.piece)){if(!t.started&&r.distanceSq(t.epos,t.rel)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if("function"==typeof t.element){const e=t.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),t.element=e}t.pos=[t.epos[0]-t.rel[0],t.epos[1]-t.rel[1]];const n=r.posToTranslateAbs(e.dom.bounds())(t.origPos,o.whitePov(e));n[0]+=t.pos[0]+t.dec[0],n[1]+=t.pos[1]+t.dec[1],r.translateAbs(t.element,n)}}else u(e);c(e)})}function u(e){const t=e.draggable.current;t&&(t.newPiece&&delete e.pieces[t.orig],e.draggable.current=void 0,o.unselect(e),l(e),e.dom.redraw())}function l(e){const t=e.dom.elements;t.ghost&&r.setVisible(t.ghost,!1)}function d(e,t,n){const o=r.key2pos(e);return t||(o[0]=9-o[0],o[1]=9-o[1]),{left:n.left+n.width*(o[0]-1)/8,top:n.top+n.height*(8-o[1])/8,width:n.width/8,height:n.height/8}}function h(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}n.start=function(e,t){if(void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),u=r.eventPosition(t),l=o.getKeyAtDomPos(u,o.whitePov(e),n);if(!l)return;const p=e.pieces[l],f=e.selected;f||!e.drawable.enabled||!e.drawable.eraseOnClick&&p&&p.color===e.turnColor||i.clear(e),!1===t.cancelable||t.touches&&e.movable.color&&!p&&!f&&!a(e,u)||t.preventDefault();const m=!!e.premovable.current,v=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&o.canMove(e,e.selected,l)?s.anim(e=>o.selectSquare(e,l),e):o.selectSquare(e,l);const g=e.selected===l,b=h(e,l);if(p&&b&&g&&o.isDraggable(e,l)){const i=d(l,o.whitePov(e),n);e.draggable.current={orig:l,origPos:r.key2pos(l),piece:p,rel:u,epos:u,pos:[0,0],dec:e.draggable.centerPiece?[u[0]-(i.left+i.width/2),u[1]-(i.top+i.height/2)]:[0,0],started:e.draggable.autoDistance&&e.stats.dragged,element:b,previouslySelected:f,originTarget:t.target},b.cgDragging=!0,b.classList.add("dragging");const s=e.dom.elements.ghost;s&&(s.className=`ghost ${p.color} ${p.role}`,r.translateAbs(s,r.posToTranslateAbs(n)(r.key2pos(l),o.whitePov(e))),r.setVisible(s,!0)),c(e)}else m&&o.unsetPremove(e),v&&o.unsetPredrop(e);e.dom.redraw()},n.pieceCloseTo=a,n.dragNewPiece=function(e,t,n,i){e.pieces.a0=t,e.dom.redraw();const s=r.eventPosition(n),a=o.whitePov(e),u=e.dom.bounds(),l=d("a0",a,u),p=[(a?0:7)*l.width+u.left,(a?8:-1)*l.height+u.top];e.draggable.current={orig:"a0",origPos:r.key2pos("a0"),piece:t,rel:p,epos:s,pos:[s[0]-p[0],s[1]-p[1]],dec:[-l.width/2,-l.height/2],started:!0,element:()=>h(e,"a0"),originTarget:n.target,newPiece:!0,force:!!i},c(e)},n.move=function(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.epos=r.eventPosition(t))},n.end=function(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);o.unsetPremove(e),o.unsetPredrop(e);const i=r.eventPosition(t)||n.epos,s=o.getKeyAtDomPos(i,o.whitePov(e),e.dom.bounds());s&&n.started&&n.orig!==s?n.newPiece?o.dropNewPiece(e,n.orig,s,n.force):(e.stats.ctrlKey=t.ctrlKey,o.userMove(e,n.orig,s)&&(e.stats.dragged=!0)):n.newPiece?delete e.pieces[n.orig]:e.draggable.deleteOnDropOff&&!s&&(delete e.pieces[n.orig],o.callUserFunction(e.events.change)),(!n||n.orig!==n.previouslySelected||n.orig!==s&&s)&&e.selectable.enabled||o.unselect(e),l(e),e.draggable.current=void 0,e.dom.redraw()},n.cancel=u},{"./anim":2,"./board":4,"./draw":8,"./util":18}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./board"),r=e("./util"),i=["green","red","blue","yellow"];function s(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=o.getKeyAtDomPos(t.pos,o.whitePov(e),e.dom.bounds());n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),s(e)}})}function a(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function c(e){return i[((e.shiftKey||e.ctrlKey)&&r.isRightButton(e)?1:0)+(e.altKey?2:0)]}function u(e){e.onChange&&e.onChange(e.shapes)}n.start=function(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?o.unselect(e):o.cancelMove(e);const n=r.eventPosition(t),i=o.getKeyAtDomPos(n,o.whitePov(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:n,brush:c(t)},s(e))},n.processDraw=s,n.move=function(e,t){e.drawable.current&&(e.drawable.current.pos=r.eventPosition(t))},n.end=function(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,o=e.shapes.filter(n)[0];o&&(e.shapes=e.shapes.filter(e=>!n(e)));o&&o.brush===t.brush||e.shapes.push(t);u(e)}(e.drawable,t),a(e))},n.cancel=a,n.clear=function(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),u(e.drawable))}},{"./board":4,"./util":18}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./board"),r=e("./util"),i=e("./drag");n.setDropMode=function(e,t){e.dropmode={active:!0,piece:t},i.cancel(e)},n.cancelDropMode=function(e){e.dropmode={active:!1}},n.drop=function(e,t){if(!e.dropmode.active)return;o.unsetPremove(e),o.unsetPredrop(e);const n=e.dropmode.piece;if(n){e.pieces.a0=n;const i=r.eventPosition(t),s=i&&o.getKeyAtDomPos(i,o.whitePov(e),e.dom.bounds());s&&o.dropNewPiece(e,"a0",s)}e.dom.redraw()}},{"./board":4,"./drag":7,"./util":18}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./drag"),r=e("./draw"),i=e("./drop"),s=e("./util");function a(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n)}function c(e,t,n){return o=>{o.shiftKey||s.isRightButton(o)?e.drawable.enabled&&n(e,o):e.viewOnly||t(e,o)}}n.bindBoard=function(e){if(e.viewOnly)return;const t=e.dom.elements.board,n=function(e){return t=>{e.draggable.current?o.cancel(e):e.drawable.current?r.cancel(e):t.shiftKey||s.isRightButton(t)?e.drawable.enabled&&r.start(e,t):e.viewOnly||(e.dropmode.active?i.drop(e,t):o.start(e,t))}}(e);t.addEventListener("touchstart",n,{passive:!1}),t.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&t.addEventListener("contextmenu",e=>e.preventDefault())},n.bindDocument=function(e,t){const n=[];if(!e.dom.relative&&e.resizable){const o=()=>{e.dom.bounds.clear(),requestAnimationFrame(t)};n.push(a(document.body,"chessground.resize",o))}if(!e.viewOnly){const t=c(e,o.move,r.move),i=c(e,o.end,r.end);["touchmove","mousemove"].forEach(e=>n.push(a(document,e,t))),["touchend","mouseup"].forEach(e=>n.push(a(document,e,i)));const s=()=>e.dom.bounds.clear();n.push(a(window,"scroll",s,{passive:!0})),n.push(a(window,"resize",s,{passive:!0}))}return()=>n.forEach(e=>e())}},{"./drag":7,"./draw":8,"./drop":9,"./util":18}],11:[function(e,t,n){"use strict";function o(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{o(e,2),setTimeout(()=>o(e,void 0),120)},120)}},{}],12:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util"),r=e("./types");n.initial="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR";const i={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},s={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};n.read=function(e){"start"===e&&(e=n.initial);const t={};let r=8,s=0;for(const n of e)switch(n){case" ":return t;case"/":if(--r,0===r)return t;s=0;break;case"~":const e=t[o.pos2key([s,r])];e&&(e.promoted=!0);break;default:const a=n.charCodeAt(0);if(a<57)s+=a-48;else{++s;const e=n.toLowerCase();t[o.pos2key([s,r])]={role:i[e],color:n===e?"black":"white"}}}return t},n.write=function(e){return o.invRanks.map(t=>r.ranks.map(n=>{const r=e[o.pos2key([n,t])];if(r){const e=s[r.role];return"white"===r.color?e.toUpperCase():e}return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}},{"./types":17,"./util":18}],13:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util");function r(e,t){return Math.abs(e-t)}const i=(e,t,n,o)=>{const i=r(e,n),s=r(t,o);return 1===i&&2===s||2===i&&1===s},s=(e,t,n,o)=>r(e,n)===r(t,o),a=(e,t,n,o)=>e===n||t===o,c=(e,t,n,o)=>s(e,t,n,o)||a(e,t,n,o);const u=o.allKeys.map(o.key2pos);n.default=function(e,t,n){const l=e[t],d=o.key2pos(t),h=l.role,p="pawn"===h?(f=l.color,(e,t,n,o)=>r(e,n)<2&&("white"===f?o===t+1||t<=2&&o===t+2&&e===n:o===t-1||t>=7&&o===t-2&&e===n)):"knight"===h?i:"bishop"===h?s:"rook"===h?a:"queen"===h?c:function(e,t,n){return(i,s,a,c)=>r(i,a)<2&&r(s,c)<2||n&&s===c&&s===("white"===e?1:8)&&(5===i&&(o.containsX(t,1)&&3===a||o.containsX(t,8)&&7===a)||o.containsX(t,a))}(l.color,function(e,t){const n="white"==t?"1":"8";return Object.keys(e).filter(o=>{const r=e[o];return o[1]===n&&r&&r.color===t&&"rook"===r.role}).map(e=>o.key2pos(e)[0])}(e,l.color),n);var f;return u.filter(e=>(d[0]!==e[0]||d[1]!==e[1])&&p(d[0],d[1],e[0],e[1])).map(o.pos2key)}},{"./util":18}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util"),r=e("./board"),i=e("./util");function s(e){return"PIECE"===e.tagName}function a(e){return"SQUARE"===e.tagName}function c(e,t){for(const n in t)e.dom.elements.board.removeChild(t[n])}function u(e,t){let n=2+8*(e[1]-1)+(8-e[0]);return t&&(n=67-n),n+""}function l(e){return`${e.color} ${e.role}`}function d(e,t,n){e[t]?e[t]+=" "+n:e[t]=n}n.default=function(e){const t=r.whitePov(e),n=e.dom.relative?i.posToTranslateRel:i.posToTranslateAbs(e.dom.bounds()),h=e.dom.relative?i.translateRel:i.translateAbs,p=e.dom.elements.board,f=e.pieces,m=e.animation.current,v=m?m.plan.anims:{},g=m?m.plan.fadings:{},b=e.draggable.current,k=function(e){const t={};let n,o;if(e.lastMove&&e.highlight.lastMove)for(n in e.lastMove)d(t,e.lastMove[n],"last-move");e.check&&e.highlight.check&&d(t,e.check,"check");if(e.selected&&(d(t,e.selected,"selected"),e.movable.showDests)){const r=e.movable.dests&&e.movable.dests[e.selected];if(r)for(n in r)o=r[n],d(t,o,"move-dest"+(e.pieces[o]?" oc":""));const i=e.premovable.dests;if(i)for(n in i)o=i[n],d(t,o,"premove-dest"+(e.pieces[o]?" oc":""))}const r=e.premovable.current;if(r)for(n in r)d(t,r[n],"current-premove");else e.predroppable.current&&d(t,e.predroppable.current.key,"current-premove");const i=e.exploding;if(i)for(n in i.keys)d(t,i.keys[n],"exploding"+i.stage);return t}(e),w={},y={},S={},P={},C=Object.keys(f);let q,M,E,O,_,x,R,A,z,T,D;for(E=p.firstChild;E;){if(q=E.cgKey,s(E))if(O=f[q],x=v[q],R=g[q],_=E.cgPiece,!E.cgDragging||b&&b.orig===q||(E.classList.remove("dragging"),h(E,n(o.key2pos(q),t)),E.cgDragging=!1),!R&&E.cgFading&&(E.cgFading=!1,E.classList.remove("fading")),O){if(x&&E.cgAnimating&&_===l(O)){const e=o.key2pos(q);e[0]+=x[2],e[1]+=x[3],E.classList.add("anim"),h(E,n(e,t))}else E.cgAnimating&&(E.cgAnimating=!1,E.classList.remove("anim"),h(E,n(o.key2pos(q),t)),e.addPieceZIndex&&(E.style.zIndex=u(o.key2pos(q),t)));_!==l(O)||R&&E.cgFading?R&&_===l(R)?(E.classList.add("fading"),E.cgFading=!0):S[_]?S[_].push(E):S[_]=[E]:w[q]=!0}else S[_]?S[_].push(E):S[_]=[E];else if(a(E)){const e=E.className;k[q]===e?y[q]=!0:P[e]?P[e].push(E):P[e]=[E]}E=E.nextSibling}for(const r in k)if(!y[r]){T=P[k[r]],D=T&&T.pop();const e=n(o.key2pos(r),t);if(D)D.cgKey=r,h(D,e);else{const t=o.createEl("square",k[r]);t.cgKey=r,h(t,e),p.insertBefore(t,p.firstChild)}}for(const r in C)if(q=C[r],M=f[q],x=v[q],!w[q])if(A=S[l(M)],z=A&&A.pop(),z){z.cgKey=q,z.cgFading&&(z.classList.remove("fading"),z.cgFading=!1);const r=o.key2pos(q);e.addPieceZIndex&&(z.style.zIndex=u(r,t)),x&&(z.cgAnimating=!0,z.classList.add("anim"),r[0]+=x[2],r[1]+=x[3]),h(z,n(r,t))}else{const r=l(M),i=o.createEl("piece",r),s=o.key2pos(q);i.cgPiece=r,i.cgKey=q,x&&(i.cgAnimating=!0,s[0]+=x[2],s[1]+=x[3]),h(i,n(s,t)),e.addPieceZIndex&&(i.style.zIndex=u(s,t)),p.appendChild(i)}for(const o in S)c(e,S[o]);for(const o in P)c(e,P[o])}},{"./board":4,"./util":18}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./fen"),r=e("./util");n.defaults=function(){return{pieces:o.read(o.initial),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,centerPiece:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:r.timer()}}},{"./fen":12,"./util":18}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util");function r(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function i({orig:e,dest:t,brush:n,piece:o,modifiers:r},i,a){return[a,e,t,n,t&&i[t]>1,o&&s(o),r&&(c=r,""+(c.lineWidth||""))].filter(e=>e).join("");var c}function s(e){return[e.color,e.role,e.scale].filter(e=>e).join("")}function a(e){const t=c(r("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(c(r("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function c(e,t){for(let n in t)e.setAttribute(n,t[n]);return e}function u(e,t){return"white"===t?e:[9-e[0],9-e[1]]}function l(e,t){const n={color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth)};return n.key=[e.key,t.lineWidth].filter(e=>e).join(""),n}function d(e,t,n){return(e.lineWidth||10)*(t?.85:1)/512*n.width}function h(e,t){return(e.opacity||1)*(t?.9:1)}function p(e,t){return[(e[0]-.5)*t.width/8,(8.5-e[1])*t.height/8]}n.createElement=r,n.renderSvg=function(e,t){const n=e.drawable,s=n.current,f=s&&s.mouseSq?s:void 0,m={};n.shapes.concat(n.autoShapes).concat(f?[f]:[]).forEach(e=>{e.dest&&(m[e.dest]=(m[e.dest]||0)+1)});const v=n.shapes.concat(n.autoShapes).map(e=>({shape:e,current:!1,hash:i(e,m,!1)}));f&&v.push({shape:f,current:!0,hash:i(f,m,!0)});const g=v.map(e=>e.hash).join("");if(g===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=g;const b=t.firstChild;!function(e,t,n){const o={};let r;t.forEach(t=>{t.shape.dest&&(r=e.brushes[t.shape.brush],t.shape.modifiers&&(r=l(r,t.shape.modifiers)),o[r.key]=r)});const i={};let s=n.firstChild;for(;s;)i[s.getAttribute("cgKey")]=!0,s=s.nextSibling;for(let c in o)i[c]||n.appendChild(a(o[c]))}(n,v,b),function(e,t,n,i,s,a){const f=e.dom.bounds(),m={},v=[];t.forEach(e=>{m[e.hash]=!1});let g,b=a.nextSibling;for(;b;)g=b.getAttribute("cgHash"),m.hasOwnProperty(g)?m[g]=!0:v.push(b),b=b.nextSibling;v.forEach(e=>s.removeChild(e)),t.forEach(t=>{m[t.hash]||s.appendChild(function(e,{shape:t,current:n,hash:i},s,a,f){let m;if(t.piece)m=function(e,t,n,o){const i=p(t,o),s=o.width/8*(n.scale||1),a=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return c(r("image"),{className:`${n.role} ${n.color}`,x:i[0]-s/2,y:i[1]-s/2,width:s,height:s,href:e+a+".svg"})}(e.drawable.pieces.baseUrl,u(o.key2pos(t.orig),e.orientation),t.piece,f);else{const i=u(o.key2pos(t.orig),e.orientation);if(t.orig&&t.dest){let v=s[t.brush];t.modifiers&&(v=l(v,t.modifiers)),m=function(e,t,n,o,i,s){const a=function(e,t){return(t?20:10)/512*e.width}(s,i&&!o),u=p(t,s),l=p(n,s),f=l[0]-u[0],m=l[1]-u[1],v=Math.atan2(m,f),g=Math.cos(v)*a,b=Math.sin(v)*a;return c(r("line"),{stroke:e.color,"stroke-width":d(e,o,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:h(e,o),x1:u[0],y1:u[1],x2:l[0]-g,y2:l[1]-b})}(v,i,u(o.key2pos(t.dest),e.orientation),n,a[t.dest]>1,f)}else m=function(e,t,n,o){const i=p(t,o),s=function(e){const t=e.width/512;return[3*t,4*t]}(o),a=(o.width+o.height)/32;return c(r("circle"),{stroke:e.color,"stroke-width":s[n?0:1],fill:"none",opacity:h(e,n),cx:i[0],cy:i[1],r:a-s[1]/2})}(s[t.brush],i,n,f)}return m.setAttribute("cgHash",i),m}(e,t,n,i,f))})}(e,v,n.brushes,m,t,b)}},{"./util":18}],17:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.files=["a","b","c","d","e","f","g","h"],n.ranks=[1,2,3,4,5,6,7,8]},{}],18:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./types");n.colors=["white","black"],n.invRanks=[8,7,6,5,4,3,2,1],n.allKeys=Array.prototype.concat(...o.files.map(e=>o.ranks.map(t=>e+t))),n.pos2key=e=>n.allKeys[8*e[0]+e[1]-9],n.key2pos=e=>[e.charCodeAt(0)-96,e.charCodeAt(1)-48],n.memo=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n},n.timer=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},n.opposite=e=>"white"===e?"black":"white",n.containsX=function(e,t){return void 0!==e&&-1!==e.indexOf(t)},n.distanceSq=(e,t)=>Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2),n.samePiece=(e,t)=>e.role===t.role&&e.color===t.color;const r=(e,t,n,o)=>[(t?e[0]-1:8-e[0])*n,(t?8-e[1]:e[1]-1)*o];n.posToTranslateAbs=e=>{const t=e.width/8,n=e.height/8;return(e,o)=>r(e,o,t,n)},n.posToTranslateRel=(e,t)=>r(e,t,100,100),n.translateAbs=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},n.translateRel=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},n.setVisible=(e,t)=>{e.style.visibility=t?"visible":"hidden"},n.eventPosition=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.touches&&e.targetTouches[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,n.isRightButton=e=>2===e.buttons||2===e.button,n.createEl=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n}},{"./types":17}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util"),r=e("./types"),i=e("./svg");function s(e,t){const n=o.createEl("coords",t);let r;for(let i in e)r=o.createEl("coord"),r.textContent=e[i],n.appendChild(r);return n}n.default=function(e,t,n){e.innerHTML="",e.classList.add("cg-wrap"),o.colors.forEach(n=>e.classList.toggle("orientation-"+n,t.orientation===n)),e.classList.toggle("manipulable",!t.viewOnly);const a=o.createEl("cg-helper");e.appendChild(a);const c=o.createEl("cg-container");a.appendChild(c);const u=o.createEl("cg-board");let l,d;if(c.appendChild(u),t.drawable.visible&&!n&&(l=i.createElement("svg"),l.appendChild(i.createElement("defs")),c.appendChild(l)),t.coordinates){const e="black"===t.orientation?" black":"";c.appendChild(s(r.ranks,"ranks"+e)),c.appendChild(s(r.files,"files"+e))}return t.draggable.showGhost&&!n&&(d=o.createEl("piece","ghost"),o.setVisible(d,!1),c.appendChild(d)),{board:u,container:c,ghost:d,svg:l}}},{"./svg":16,"./types":17,"./util":18}],20:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./util"),r=e("./squareSet");function i(e,t,n){let i=r.SquareSet.empty();for(const r of t)for(let t=e+r;0<=t&&t<64&&o.squareDist(t,t-r)<=2&&(i=i.with(t),!n);t+=r);return i}function s(e,t){const n=[];for(let o=0;o<64;o++)n[o]=i(o,e,t);return n}const a=s([-9,-8,-7,-1,1,7,8,9],!0),c=s([-17,-15,-10,-6,6,10,15,17],!0),u={white:s([7,9],!0),black:s([-7,-9],!0)};function l(e){return a[e]}function d(e){return c[e]}function h(e,t){return u[e][t]}n.kingAttacks=l,n.knightAttacks=d,n.pawnAttacks=h;const p=s([-8,8],!1),f=s([-1,1],!1),m=s([-9,9],!1),v=s([-7,7],!1);function g(e,t,n){let o=n.intersect(t),r=o.bswap64();return o=o.minus64(e),r=r.minus64(e.bswap64()),o=o.xor(r.bswap64()),o.intersect(t)}function b(e,t){return g(r.SquareSet.fromSquare(e),p[e],t)}function k(e,t){const n=f[e];let o=t.intersect(n),i=o.rbit64();return o=o.minus64(r.SquareSet.fromSquare(e)),i=i.minus64(r.SquareSet.fromSquare(63-e)),o=o.xor(i.rbit64()),o.intersect(n)}function w(e,t){return g(r.SquareSet.fromSquare(e),m[e],t)}function y(e,t){return g(r.SquareSet.fromSquare(e),v[e],t)}function S(e,t){const n=r.SquareSet.fromSquare(e);return g(n,m[e],t).xor(g(n,v[e],t))}function P(e,t){return b(e,t).xor(k(e,t))}function C(e,t){return S(e,t).xor(P(e,t))}n.bishopAttacks=S,n.rookAttacks=P,n.queenAttacks=C,n.attacks=function(e,t,n){switch(e.role){case"pawn":return h(e.color,t);case"knight":return d(t);case"bishop":return S(t,n);case"rook":return P(t,n);case"queen":return C(t,n);case"king":return l(t)}};const[q,M]=function(){const e=[],t=[],n=r.SquareSet.empty();for(let o=0;o<64;o++){e[o]=[],t[o]=[];for(let r=0;r<64;r++)e[o][r]=n,t[o][r]=n;for(const n of m[o])e[o][n]=m[o].with(o),t[o][n]=w(o,r.SquareSet.fromSquare(n)).intersect(w(n,r.SquareSet.fromSquare(o)));for(const n of v[o])e[o][n]=v[o].with(o),t[o][n]=y(o,r.SquareSet.fromSquare(n)).intersect(y(n,r.SquareSet.fromSquare(o)));for(const n of p[o])e[o][n]=p[o].with(o),t[o][n]=b(o,r.SquareSet.fromSquare(n)).intersect(b(n,r.SquareSet.fromSquare(o)));for(const n of f[o])e[o][n]=f[o].with(o),t[o][n]=k(o,r.SquareSet.fromSquare(n)).intersect(k(n,r.SquareSet.fromSquare(o)))}return[e,t]}();n.ray=function(e,t){return q[e][t]},n.between=function(e,t){return M[e][t]}},{"./squareSet":26,"./util":28}],21:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./types"),r=e("./squareSet");class i{constructor(){}static default(){const e=new i;return e.reset(),e}static racingKings(){const e=new i;return e.occupied=new r.SquareSet(65535,0),e.promoted=r.SquareSet.empty(),e.white=new r.SquareSet(61680,0),e.black=new r.SquareSet(3855,0),e.pawn=r.SquareSet.empty(),e.knight=new r.SquareSet(6168,0),e.bishop=new r.SquareSet(9252,0),e.rook=new r.SquareSet(16962,0),e.queen=new r.SquareSet(129,0),e.king=new r.SquareSet(33024,0),e}static horde(){const e=new i;return e.occupied=new r.SquareSet(4294967295,4294901862),e.promoted=r.SquareSet.empty(),e.white=new r.SquareSet(4294967295,102),e.black=new r.SquareSet(0,4294901760),e.pawn=new r.SquareSet(4294967295,16711782),e.knight=new r.SquareSet(0,1107296256),e.bishop=new r.SquareSet(0,603979776),e.rook=new r.SquareSet(0,2164260864),e.queen=new r.SquareSet(0,134217728),e.king=new r.SquareSet(0,268435456),e}reset(){this.occupied=new r.SquareSet(65535,4294901760),this.promoted=r.SquareSet.empty(),this.white=new r.SquareSet(65535,0),this.black=new r.SquareSet(0,4294901760),this.pawn=new r.SquareSet(65280,16711680),this.knight=new r.SquareSet(66,1107296256),this.bishop=new r.SquareSet(36,603979776),this.rook=new r.SquareSet(129,2164260864),this.queen=new r.SquareSet(8,134217728),this.king=new r.SquareSet(16,268435456)}static empty(){const e=new i;return e.clear(),e}clear(){this.occupied=r.SquareSet.empty(),this.promoted=r.SquareSet.empty();for(const e of o.COLORS)this[e]=r.SquareSet.empty();for(const e of o.ROLES)this[e]=r.SquareSet.empty()}clone(){const e=new i;e.occupied=this.occupied,e.promoted=this.promoted;for(const t of o.COLORS)e[t]=this[t];for(const t of o.ROLES)e[t]=this[t];return e}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(const t of o.ROLES)if(this[t].has(e))return t}get(e){const t=this.getColor(e);if(!t)return;const n=this.promoted.has(e);return{color:t,role:this.getRole(e),promoted:n}}take(e){const t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){const n=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}[Symbol.iterator](){const e=this.occupied[Symbol.iterator]();return{next:()=>{const t=e.next();return t.done?{done:!0}:{value:[t.value,this.get(t.value)],done:!1}}}}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.king.intersect(this[e]).diff(this.promoted).singleSquare()}}n.Board=i},{"./squareSet":26,"./types":27}],22:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("@badrap/result"),r=e("./types"),i=e("./squareSet"),s=e("./board"),a=e("./attacks"),c=e("./util");var u;!function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(u=n.IllegalSetup||(n.IllegalSetup={}));class l extends Error{}function d(e,t){return"white"===e?"a"===t?2:6:"a"===t?58:62}function h(e,t){return"white"===e?"a"===t?3:5:"a"===t?59:61}n.PositionError=l;class p{constructor(){}static default(){const e=new p;return e.unmovedRooks=i.SquareSet.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new i.SquareSet(96,0),h:new i.SquareSet(0,14)},black:{a:new i.SquareSet(0,1610612736),h:new i.SquareSet(0,234881024)}},e}static empty(){const e=new p;return e.unmovedRooks=i.SquareSet.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:i.SquareSet.empty(),h:i.SquareSet.empty()},black:{a:i.SquareSet.empty(),h:i.SquareSet.empty()}},e}clone(){const e=new p;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,n,o){const r=d(e,t),i=h(e,t);this.unmovedRooks=this.unmovedRooks.with(o),this.rook[e][t]=o,this.path[e][t]=a.between(o,i).with(i).union(a.between(n,r).with(r)).without(n).without(o)}static fromSetup(e){const t=p.empty(),n=e.unmovedRooks.intersect(e.board.rook);for(const o of r.COLORS){const r=i.SquareSet.backrank(o),s=e.board.kingOf(o);if(!c.defined(s)||!r.has(s))continue;const a=n.intersect(e.board[o]).intersect(r),u=a.first();c.defined(u)&&u<s&&t.add(o,"a",s,u);const l=a.last();c.defined(l)&&s<l&&t.add(o,"h",s,l)}return t}discardRook(e){if(this.unmovedRooks.has(e)){this.unmovedRooks=this.unmovedRooks.without(e);for(const t of r.COLORS)for(const n of r.CASTLING_SIDES)this.rook[t][n]===e&&(this.rook[t][n]=void 0)}}discardSide(e){this.unmovedRooks=this.unmovedRooks.diff(i.SquareSet.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}n.Castles=p;class f{constructor(e){this.rules=e}kingAttackers(e,t,n){return function(e,t,n,o){return n[t].intersect(a.rookAttacks(e,o).intersect(n.rooksAndQueens()).union(a.bishopAttacks(e,o).intersect(n.bishopsAndQueens())).union(a.knightAttacks(e).intersect(n.knight)).union(a.kingAttacks(e).intersect(n.king)).union(a.pawnAttacks(c.opposite(t),e).intersect(n.pawn)))}(e,t,this.board,n)}dropDests(e){return i.SquareSet.empty()}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[c.opposite(t.color)][t.role]++}ctx(){const e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!c.defined(t))return{king:t,blockers:i.SquareSet.empty(),checkers:i.SquareSet.empty(),variantEnd:e,mustCapture:!1};const n=a.rookAttacks(t,i.SquareSet.empty()).intersect(this.board.rooksAndQueens()).union(a.bishopAttacks(t,i.SquareSet.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[c.opposite(this.turn)]);let o=i.SquareSet.empty();for(const r of n){const e=a.between(t,r).intersect(this.board.occupied);e.moreThanOne()||(o=o.union(e))}return{king:t,blockers:o,checkers:this.kingAttackers(t,c.opposite(this.turn),this.board.occupied),variantEnd:e,mustCapture:!1}}clone(){const e=new this.constructor;return e.board=this.board.clone(),e.pockets=this.pockets&&this.pockets.clone(),e.turn=this.turn,e.castles=this.castles.clone(),e.epSquare=this.epSquare,e.remainingChecks=this.remainingChecks&&this.remainingChecks.clone(),e.halfmoves=this.halfmoves,e.fullmoves=this.fullmoves,e}toSetup(){return{board:this.board.clone(),pockets:this.pockets&&this.pockets.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.hasLegalEp()?this.epSquare:void 0,remainingChecks:this.remainingChecks&&this.remainingChecks.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return r.COLORS.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){for(const t of this.board[this.turn])if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){return r.isDrop(e)?!(!this.pockets||this.pockets[this.turn][e.role]<=0)&&(("pawn"!==e.role||!i.SquareSet.backranks().has(e.to))&&this.dropDests(t).has(e.to)):"pawn"!==e.promotion&&(("king"!==e.promotion||"antichess"===this.rules)&&(!(!e.promotion&&this.board.pawn.has(e.from)&&i.SquareSet.backranks().has(e.to))&&this.dests(e.from,t).has(e.to)))}isCheck(){const e=this.board.kingOf(this.turn);return c.defined(e)&&this.kingAttackers(e,c.opposite(this.turn),this.board.occupied).nonEmpty()}isEnd(){return this.isVariantEnd()||this.isInsufficientMaterial()||!this.hasDests(this.ctx())}isCheckmate(){if(this.isVariantEnd())return!1;const e=this.ctx();return e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(){if(this.isVariantEnd())return!1;const e=this.ctx();return e.checkers.isEmpty()&&!this.hasDests(e)}outcome(){const e=this.variantOutcome();return e||(this.isCheckmate()?{winner:c.opposite(this.turn)}:this.isInsufficientMaterial()||this.isStalemate()?{winner:void 0}:void 0)}allDests(){const e=this.ctx(),t=new Map;if(e.variantEnd)return t;for(const n of this.board[this.turn])t.set(n,this.dests(n,e));return t}play(e){const t=this.turn,n=this.epSquare;if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=c.opposite(t),r.isDrop(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{const o=this.board.take(e.from);if(!o)return;let r;if("pawn"===o.role){this.halfmoves=0,e.to===n&&(r=this.board.take(e.to+("white"===t?-8:8)));const i=e.from-e.to;16===Math.abs(i)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(o.role=e.promotion,o.promoted=!0)}else if("rook"===o.role)this.castles.discardRook(e.from);else if("king"===o.role){const n=e.to-e.from,r=2===Math.abs(n)||this.board[t].has(e.to);if(r){const e=n>0?"h":"a",r=this.castles.rook[t][e];if(c.defined(r)){const n=this.board.take(r);this.board.set(d(t,e),o),n&&this.board.set(h(t,e),n)}}if(this.castles.discardSide(t),r)return}const i=this.board.set(e.to,o)||r;i&&this.playCaptureAt(e.to,i)}}hasLegalEp(){if(!this.epSquare)return!1;const e=this.ctx(),t=this.board.pieces(this.turn,"pawn").intersect(a.pawnAttacks(c.opposite(this.turn),this.epSquare));for(const n of t)if(this.dests(n,e).has(this.epSquare))return!0;return!1}}n.Position=f;n.Chess=class extends f{constructor(e){super(e||"chess")}static default(){const e=new this;return e.board=s.Board.default(),e.pockets=void 0,e.turn="white",e.castles=p.default(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){const t=new this;return t.board=e.board.clone(),t.pockets=void 0,t.turn=e.turn,t.castles=p.fromSetup(e),t.epSquare=t.validEpSquare(e.epSquare),t.remainingChecks=void 0,t.halfmoves=e.halfmoves,t.fullmoves=e.fullmoves,t.validate().map(e=>t)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return o.Result.err(new l(u.Empty));if(2!==this.board.king.size())return o.Result.err(new l(u.Kings));if(!c.defined(this.board.kingOf(this.turn)))return o.Result.err(new l(u.Kings));const e=this.board.kingOf(c.opposite(this.turn));return c.defined(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?o.Result.err(new l(u.OppositeCheck)):i.SquareSet.backranks().intersects(this.board.pawn)?o.Result.err(new l(u.PawnsOnBackrank)):o.Result.ok(void 0):o.Result.err(new l(u.Kings))}validEpSquare(e){if(!e)return;const t="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(e>>3!==t)return;if(this.board.occupied.has(e+n))return;const o=e-n;return this.board.pawn.has(o)&&this.board[c.opposite(this.turn)].has(o)?e:void 0}castlingDest(e,t){if(!c.defined(t.king)||t.checkers.nonEmpty())return i.SquareSet.empty();const n=this.castles.rook[this.turn][e];if(!c.defined(n))return i.SquareSet.empty();if(this.castles.path[this.turn][e].intersects(this.board.occupied))return i.SquareSet.empty();const o=d(this.turn,e),r=a.between(t.king,o),s=this.board.occupied.without(t.king);for(const a of r)if(this.kingAttackers(a,c.opposite(this.turn),s).nonEmpty())return i.SquareSet.empty();const u=h(this.turn,e),l=this.board.occupied.toggle(t.king).toggle(n).toggle(u);return this.kingAttackers(o,c.opposite(this.turn),l).nonEmpty()?i.SquareSet.empty():i.SquareSet.fromSquare(n)}canCaptureEp(e,t){if(!c.defined(this.epSquare))return!1;if(!a.pawnAttacks(this.turn,e).has(this.epSquare))return!1;if(!c.defined(t.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),o=this.board.occupied.toggle(e).toggle(this.epSquare).toggle(n);return!this.kingAttackers(t.king,c.opposite(this.turn),o).intersects(o)}pseudoDests(e,t){if(t.variantEnd)return i.SquareSet.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return i.SquareSet.empty();let o=a.attacks(n,e,this.board.occupied);if("pawn"===n.role){let t=this.board[c.opposite(this.turn)];c.defined(this.epSquare)&&(t=t.with(this.epSquare)),o=o.intersect(t);const n="white"===this.turn?8:-8,r=e+n;if(0<=r&&r<64&&!this.board.occupied.has(r)){o=o.with(r);const t=r+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(o=o.with(t))}return o}return o=o.diff(this.board[this.turn]),e===t.king?o.union(this.castlingDest("a",t)).union(this.castlingDest("h",t)):o}dests(e,t){if(t.variantEnd)return i.SquareSet.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return i.SquareSet.empty();let o,r;if("pawn"===n.role){o=a.pawnAttacks(this.turn,e).intersect(this.board[c.opposite(this.turn)]);const n="white"===this.turn?8:-8,s=e+n;if(0<=s&&s<64&&!this.board.occupied.has(s)){o=o.with(s);const t=s+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(o=o.with(t))}if(c.defined(this.epSquare)&&this.canCaptureEp(e,t)){const e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(r=i.SquareSet.fromSquare(this.epSquare))}}else o="bishop"===n.role?a.bishopAttacks(e,this.board.occupied):"knight"===n.role?a.knightAttacks(e):"rook"===n.role?a.rookAttacks(e,this.board.occupied):"queen"===n.role?a.queenAttacks(e,this.board.occupied):a.kingAttacks(e);if(o=o.diff(this.board[this.turn]),c.defined(t.king)){if("king"===n.role){const n=this.board.occupied.without(e);for(const e of o)this.kingAttackers(e,c.opposite(this.turn),n).nonEmpty()&&(o=o.without(e));return o.union(this.castlingDest("a",t)).union(this.castlingDest("h",t))}if(t.checkers.nonEmpty()){const e=t.checkers.singleSquare();if(!c.defined(e))return i.SquareSet.empty();o=o.intersect(a.between(e,t.king).with(e))}t.blockers.has(e)&&(o=o.intersect(a.ray(e,t.king)))}return r&&(o=o.union(r)),o}isVariantEnd(){return!1}variantOutcome(){}hasInsufficientMaterial(e){if(this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[e].intersects(this.board.knight))return this.board[e].size()<=2&&this.board[c.opposite(e)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[e].intersects(this.board.bishop)){return(!this.board.bishop.intersects(i.SquareSet.darkSquares())||!this.board.bishop.intersects(i.SquareSet.lightSquares()))&&this.board[c.opposite(e)].diff(this.board.king).diff(this.board.rook).diff(this.board.queen).isEmpty()}return!0}}},{"./attacks":20,"./board":21,"./squareSet":26,"./types":27,"./util":28,"@badrap/result":1}],23:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("@badrap/result"),r=e("./types"),i=e("./squareSet"),s=e("./board"),a=e("./setup"),c=e("./util");var u;n.INITIAL_BOARD_FEN="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",n.INITIAL_EPD=n.INITIAL_BOARD_FEN+" w KQkq -",n.INITIAL_FEN=n.INITIAL_EPD+" 0 1",n.EMPTY_BOARD_FEN="8/8/8/8/8/8/8/8",n.EMPTY_EPD=n.EMPTY_BOARD_FEN+" w - -",n.EMPTY_FEN=n.EMPTY_EPD+" 0 1",function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(u=n.InvalidFen||(n.InvalidFen={}));class l extends Error{}function d(e){return/^\d{1,4}$/.test(e)?parseInt(e,10):void 0}function h(e){const t=c.charToRole(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}}function p(e){const t=s.Board.empty();let n=7,r=0;for(let i=0;i<e.length;i++){const s=e[i];if("/"===s&&8===r)r=0,n--;else{const a=parseInt(s,10);if(a)r+=a;else{if(r>=8||n<0)return o.Result.err(new l(u.Board));const a=r+8*n,c=h(s);if(!c)return o.Result.err(new l(u.Board));"~"===e[i+1]&&(c.promoted=!0,i++),t.set(a,c),r++}}}return 0!==n||8!==r?o.Result.err(new l(u.Board)):o.Result.ok(t)}function f(e){if(e.length>64)return o.Result.err(new l(u.Pockets));const t=a.Material.empty();for(const n of e){const e=h(n);if(!e)return o.Result.err(new l(u.Pockets));t[e.color][e.role]++}return o.Result.ok(t)}function m(e,t){let n=i.SquareSet.empty();if("-"===t)return o.Result.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(t))return o.Result.err(new l(u.Castling));for(const o of t){const t=o.toLowerCase(),r=o===t?"black":"white",s=i.SquareSet.backrank(r).intersect(e[r]);let a;a="q"===t?s:"k"===t?s.reversed():i.SquareSet.fromSquare(t.charCodeAt(0)-"a".charCodeAt(0)).intersect(s);for(const o of a){if(e.king.has(o)&&!e.promoted.has(o))break;if(e.rook.has(o)){n=n.with(o);break}}}return o.Result.ok(n)}function v(e){const t=e.split("+");if(3===t.length&&""===t[0]){const e=d(t[1]),n=d(t[2]);return!c.defined(e)||e>3||!c.defined(n)||n>3?o.Result.err(new l(u.RemainingChecks)):o.Result.ok(new a.RemainingChecks(3-e,3-n))}if(2===t.length){const e=d(t[0]),n=d(t[1]);return!c.defined(e)||e>3||!c.defined(n)||n>3?o.Result.err(new l(u.RemainingChecks)):o.Result.ok(new a.RemainingChecks(e,n))}return o.Result.err(new l(u.RemainingChecks))}function g(e,t){let n=c.roleToChar(e.role);return"white"===e.color&&(n=n.toUpperCase()),t&&t.promoted&&e.promoted&&(n+="~"),n}function b(e,t){let n="",o=0;for(let r=7;r>=0;r--)for(let i=0;i<8;i++){const s=i+8*r,a=e.get(s);a?(o&&(n+=o,o=0),n+=g(a,t)):o++,7===i&&(o&&(n+=o,o=0),0!==r&&(n+="/"))}return n}function k(e){return r.ROLES.map(t=>c.roleToChar(t).repeat(e[t])).join("")}function w(e){return k(e.white).toUpperCase()+k(e.black)}function y(e,t,n){const o=n&&n.shredder;let s="";for(const a of r.COLORS){const n=i.SquareSet.backrank(a),r=e.kingOf(a);if(!c.defined(r)||!n.has(r))continue;const u=e.pieces(a,"rook").intersect(n);for(const e of t.intersect(u).reversed())!o&&e===u.first()&&e<r?s+="white"===a?"Q":"q":!o&&e===u.last()&&r<e?s+="white"===a?"K":"k":s+=("white"===a?"ABCDEFGH":"abcdefgh")[7&e]}return s||"-"}function S(e){return`${e.white}+${e.black}`}n.FenError=l,n.parseBoardFen=p,n.parsePockets=f,n.parseCastlingFen=m,n.parseRemainingChecks=v,n.parseFen=function(e){const t=e.split(" "),n=t.shift();let r,s,a=o.Result.ok(void 0);if(n.endsWith("]")){const e=n.indexOf("[");if(-1===e)return o.Result.err(new l(u.Fen));r=p(n.substr(0,e)),a=f(n.substr(e+1,n.length-1-e-1))}else{const e=function(e,t,n){let o=e.indexOf(t);for(;n-- >0&&-1!==o;)o=e.indexOf(t,o+t.length);return o}(n,"/",7);-1===e?r=p(n):(r=p(n.substr(0,e)),a=f(n.substr(e+1)))}const h=t.shift();if(c.defined(h)&&"w"!==h){if("b"!==h)return o.Result.err(new l(u.Turn));s="black"}else s="white";return r.chain(e=>{const n=t.shift(),r=c.defined(n)?m(e,n):o.Result.ok(i.SquareSet.empty()),h=t.shift();let p;if(c.defined(h)&&"-"!==h&&(p=c.parseSquare(h),!c.defined(p)))return o.Result.err(new l(u.EpSquare));let f,g=t.shift();c.defined(g)&&g.includes("+")&&(f=v(g),g=t.shift());const b=c.defined(g)?d(g):0;if(!c.defined(b))return o.Result.err(new l(u.Halfmoves));const k=t.shift(),w=c.defined(k)?d(k):1;if(!c.defined(w))return o.Result.err(new l(u.Fullmoves));const y=t.shift();let S=o.Result.ok(void 0);if(c.defined(y)){if(c.defined(f))return o.Result.err(new l(u.RemainingChecks));S=v(y)}else c.defined(f)&&(S=f);return t.length?o.Result.err(new l(u.Fen)):a.chain(t=>r.chain(n=>S.map(o=>({board:e,pockets:t,turn:s,unmovedRooks:n,remainingChecks:o,epSquare:p,halfmoves:b,fullmoves:Math.max(1,w)}))))})},n.parsePiece=function(e){if(!e)return;const t=h(e[0]);if(t){if(2===e.length&&"~"===e[1])t.promoted=!0;else if(e.length>1)return;return t}},n.makePiece=g,n.makeBoardFen=b,n.makePockets=w,n.makeCastlingFen=y,n.makeRemainingChecks=S,n.makeFen=function(e,t){return[b(e.board,t)+(e.pockets?`[${w(e.pockets)}]`:""),e.turn[0],y(e.board,e.unmovedRooks,t),c.defined(e.epSquare)?c.makeSquare(e.epSquare):"-",...e.remainingChecks?[S(e.remainingChecks)]:[],...t&&t.epd?[]:[e.halfmoves,e.fullmoves]].join(" ")}},{"./board":21,"./setup":25,"./squareSet":26,"./types":27,"./util":28,"@badrap/result":1}],24:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./types"),r=e("./util"),i=e("./squareSet"),s=e("./attacks");function a(e,t){let n="";if(o.isDrop(t))"pawn"!==t.role&&(n=r.roleToChar(t.role).toUpperCase()),n+="@"+r.makeSquare(t.to);else{const o=e.board.getRole(t.from);if(!o)return"--";if("king"!==o||!e.board[e.turn].has(t.to)&&2!==Math.abs(t.to-t.from)){const a=e.board.occupied.has(t.to)||"pawn"===o&&(7&t.from)!=(7&t.to);if("pawn"!==o){let a;if(n=r.roleToChar(o).toUpperCase(),a="king"===o?s.kingAttacks(t.to).intersect(e.board.king):"queen"===o?s.queenAttacks(t.to,e.board.occupied).intersect(e.board.queen):"rook"===o?s.rookAttacks(t.to,e.board.occupied).intersect(e.board.rook):"bishop"===o?s.bishopAttacks(t.to,e.board.occupied).intersect(e.board.bishop):s.knightAttacks(t.to).intersect(e.board.knight),a=a.intersect(e.board[e.turn]).without(t.from),a.nonEmpty()){const o=e.ctx();for(const n of a)e.dests(n,o).has(t.to)||(a=a.without(n));if(a.nonEmpty()){let e=!1,o=a.intersects(i.SquareSet.fromRank(t.from>>3));a.intersects(i.SquareSet.fromFile(7&t.from))?e=!0:o=!0,o&&(n+="abcdefgh"[7&t.from]),e&&(n+="12345678"[t.from>>3])}}}else a&&(n="abcdefgh"[7&t.from]);a&&(n+="x"),n+=r.makeSquare(t.to),t.promotion&&(n+="="+r.roleToChar(t.promotion).toUpperCase())}else n=t.to>t.from?"O-O":"O-O-O"}return n}function c(e,t){const n=a(e,t);e.play(t);const o=e.outcome();return o&&o.winner?n+"#":e.isCheck()?n+"+":n}n.makeSanAndPlay=c,n.makeSanVariation=function(e,t){e=e.clone();let n="";for(let o=0;o<t.length;o++){0!==o&&(n+=" "),"white"===e.turn?n+=e.fullmoves+". ":0===o&&(n=e.fullmoves+"... ");const r=a(e,t[o]);if(e.play(t[o]),n+=r,"--"===r)return n;let i=!1;if(o===t.length-1){const t=e.outcome();i=!(!t||!t.winner)}i?n+="#":e.isCheck()&&(n+="+")}return n},n.makeSan=function(e,t){return c(e.clone(),t)}},{"./attacks":20,"./squareSet":26,"./types":27,"./util":28}],25:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./types"),r=e("./squareSet"),i=e("./board");class s{constructor(){}static empty(){const e=new s;for(const t of o.ROLES)e[t]=0;return e}clone(){const e=new s;for(const t of o.ROLES)e[t]=this[t];return e}nonEmpty(){return o.ROLES.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}n.MaterialSide=s;class a{constructor(e,t){this.white=e,this.black=t}static empty(){return new a(s.empty(),s.empty())}clone(){return new a(this.white.clone(),this.black.clone())}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}n.Material=a;class c{constructor(e,t){this.white=e,this.black=t}static default(){return new c(3,3)}clone(){return new c(this.white,this.black)}}n.RemainingChecks=c,n.defaultSetup=function(){return{board:i.Board.default(),pockets:void 0,turn:"white",unmovedRooks:r.SquareSet.corners(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1}}},{"./board":21,"./squareSet":26,"./types":27}],26:[function(e,t,n){"use strict";function o(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>24}function r(e){return(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16}function i(e){return e=(e=(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4)>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16}Object.defineProperty(n,"__esModule",{value:!0});class s{constructor(e,t){this.lo=e,this.hi=t,this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new s(0,1<<e-32):new s(1<<e,0)}static fromRank(e){return new s(255,0).shl64(8*e)}static fromFile(e){return new s(16843009<<e,16843009<<e)}static empty(){return new s(0,0)}static full(){return new s(4294967295,4294967295)}static corners(){return new s(129,2164260864)}static center(){return new s(402653184,24)}static backranks(){return new s(255,4278190080)}static backrank(e){return"white"===e?new s(255,0):new s(0,4278190080)}static lightSquares(){return new s(1437226410,1437226410)}static darkSquares(){return new s(2857740885,2857740885)}complement(){return new s(~this.lo,~this.hi)}xor(e){return new s(this.lo^e.lo,this.hi^e.hi)}union(e){return new s(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new s(this.lo&e.lo,this.hi&e.hi)}diff(e){return new s(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?s.empty():e>=32?new s(this.hi>>>e-32,0):e>0?new s(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?s.empty():e>=32?new s(0,this.lo<<e-32):e>0?new s(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new s(r(this.hi),r(this.lo))}rbit64(){return new s(i(this.hi),i(this.lo))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return o(this.lo)+o(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return!!(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new s(this.lo,this.hi|1<<e-32):new s(this.lo|1<<e,this.hi)}without(e){return e>=32?new s(this.lo,this.hi&~(1<<e-32)):new s(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new s(this.lo,this.hi^1<<e-32):new s(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}moreThanOne(){return!!(this.hi&&this.lo||this.lo&this.lo-1||this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}[Symbol.iterator](){let e=this.lo,t=this.hi;return{next(){if(e){const t=31-Math.clz32(e&-e);return e^=1<<t,{value:t,done:!1}}if(t){const e=31-Math.clz32(t&-t);return t^=1<<e,{value:32+e,done:!1}}return{done:!0}}}}reversed(){let e=this.lo,t=this.hi;return{[Symbol.iterator]:()=>({next(){if(t){const e=31-Math.clz32(t);return t^=1<<e,{value:32+e,done:!1}}if(e){const t=31-Math.clz32(e);return e^=1<<t,{value:t,done:!1}}return{done:!0}}})}}minus64(e){const t=this.lo-e.lo,n=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new s(t,this.hi-(e.hi+n))}}n.SquareSet=s},{}],27:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.COLORS=["white","black"],n.ROLES=["pawn","knight","bishop","rook","queen","king"],n.CASTLING_SIDES=["a","h"],n.isDrop=function(e){return"role"in e},n.isMove=function(e){return"from"in e},n.RULES=["chess","antichess","kingofthehill","3check","atomic","horde","racingkings","crazyhouse"]},{}],28:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./types");function r(e){return void 0!==e}function i(e){switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}}function s(e){switch(e){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}function a(e){if(/^[a-h][1-8]$/.test(e))return e.charCodeAt(0)-"a".charCodeAt(0)+8*(e.charCodeAt(1)-"1".charCodeAt(0))}function c(e){return"abcdefgh"[7&e]+"12345678"[e>>3]}n.defined=r,n.opposite=function(e){return"white"===e?"black":"white"},n.squareDist=function(e,t){const n=7&e,o=7&t,r=e>>3,i=t>>3;return Math.max(Math.abs(n-o),Math.abs(r-i))},n.squareRank=function(e){return e>>3},n.squareFile=function(e){return 7&e},n.roleToChar=i,n.charToRole=s,n.parseSquare=a,n.makeSquare=c,n.parseUci=function(e){if("@"===e[1]&&4===e.length){const t=s(e[0]),n=a(e.slice(2));if(t&&r(n))return{role:t,to:n}}else if(4===e.length||5===e.length){const t=a(e.slice(0,2)),n=a(e.slice(2,4));let o;if(5===e.length&&(o=s(e[4]),!o))return;if(r(t)&&r(n))return{from:t,to:n,promotion:o}}},n.makeUci=function(e){return o.isDrop(e)?`${i(e.role).toUpperCase()}@${c(e.to)}`:c(e.from)+c(e.to)+(e.promotion?i(e.promotion):"")}},{"./types":27}],29:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("@badrap/result"),r=e("./types"),i=e("./util"),s=e("./attacks"),a=e("./squareSet"),c=e("./board"),u=e("./setup"),l=e("./chess");n.PositionError=l.PositionError,n.Position=l.Position,n.IllegalSetup=l.IllegalSetup,n.Castles=l.Castles,n.Chess=l.Chess;class d extends l.Chess{constructor(){super("crazyhouse")}static default(){const e=super.default();return e.pockets=u.Material.empty(),e}static fromSetup(e){return super.fromSetup(e).map(t=>(t.pockets=e.pockets?e.pockets.clone():u.Material.empty(),t))}validate(){return super.validate().chain(e=>this.pockets&&(this.pockets.white.king>0||this.pockets.black.king>0)?o.Result.err(new l.PositionError(l.IllegalSetup.Kings)):(this.pockets?this.pockets.count():0)+this.board.occupied.size()>64?o.Result.err(new l.PositionError(l.IllegalSetup.Variant)):o.Result.ok(void 0))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.pockets?this.board.occupied.size()+this.pockets.count()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.white.pawn<=0&&this.pockets.black.pawn<=0&&this.pockets.white.rook<=0&&this.pockets.black.rook<=0&&this.pockets.white.queen<=0&&this.pockets.black.queen<=0:super.hasInsufficientMaterial(e)}dropDests(e){const t=this.board.occupied.complement().intersect(this.pockets&&this.pockets[this.turn].hasNonPawns()?a.SquareSet.full():this.pockets&&this.pockets[this.turn].pawn?a.SquareSet.backranks().complement():a.SquareSet.empty());if(i.defined(e.king)&&e.checkers.nonEmpty()){const n=e.checkers.singleSquare();return i.defined(n)?t.intersect(s.between(n,e.king)):a.SquareSet.empty()}return t}}n.Crazyhouse=d;class h extends l.Chess{constructor(){super("atomic")}static default(){return super.default()}static fromSetup(e){return super.fromSetup(e)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return o.Result.err(new l.PositionError(l.IllegalSetup.Empty));if(this.board.king.size()>2)return o.Result.err(new l.PositionError(l.IllegalSetup.Kings));const e=this.board.kingOf(i.opposite(this.turn));return i.defined(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?o.Result.err(new l.PositionError(l.IllegalSetup.OppositeCheck)):a.SquareSet.backranks().intersects(this.board.pawn)?o.Result.err(new l.PositionError(l.IllegalSetup.PawnsOnBackrank)):o.Result.ok(void 0):o.Result.err(new l.PositionError(l.IllegalSetup.Kings))}kingAttackers(e,t,n){return s.kingAttacks(e).intersects(this.board.pieces(t,"king"))?a.SquareSet.empty():super.kingAttackers(e,t,n)}playCaptureAt(e,t){super.playCaptureAt(e,t),this.board.take(e);for(const n of s.kingAttacks(e).intersect(this.board.occupied).diff(this.board.pawn)){const e=this.board.take(n);e&&"rook"===e.role&&this.castles.discardRook(n),e&&"king"===e.role&&this.castles.discardSide(e.color)}}hasInsufficientMaterial(e){if(this.board.pieces(i.opposite(e),"king").isEmpty())return!1;if(this.board[e].diff(this.board.king).isEmpty())return!0;if(this.board[i.opposite(e)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(a.SquareSet.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(a.SquareSet.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(a.SquareSet.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(a.SquareSet.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(!!this.board.knight.union(this.board.bishop).union(this.board.rook).isSingleSquare()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(e,t){let n=a.SquareSet.empty();for(const o of this.pseudoDests(e,t)){const t=this.clone();t.play({from:e,to:o});const r=t.board.kingOf(this.turn);!i.defined(r)||i.defined(t.board.kingOf(t.turn))&&!t.kingAttackers(r,t.turn,t.board.occupied).isEmpty()||(n=n.with(o))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(){for(const e of r.COLORS)if(this.board.pieces(e,"king").isEmpty())return{winner:i.opposite(e)}}}n.Atomic=h;class p extends l.Chess{constructor(){super("antichess")}static default(){const e=new this;return e.board=c.Board.default(),e.turn="white",e.castles=l.Castles.empty(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){return super.fromSetup(e).map(e=>(e.castles=l.Castles.empty(),e))}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?o.Result.err(new l.PositionError(l.IllegalSetup.Empty)):a.SquareSet.backranks().intersects(this.board.pawn)?o.Result.err(new l.PositionError(l.IllegalSetup.PawnsOnBackrank)):o.Result.ok(void 0)}kingAttackers(e,t,n){return a.SquareSet.empty()}ctx(){const e=super.ctx(),t=this.board[i.opposite(this.turn)];for(const n of this.board[this.turn])if(this.pseudoDests(n,e).intersects(t)){e.mustCapture=!0;break}return e}dests(e,t){const n=this.pseudoDests(e,t);return t.mustCapture?n.intersect(this.board[i.opposite(this.turn)]):n}hasInsufficientMaterial(e){if(this.board.occupied.equals(this.board.bishop)){const t=this.board[e].intersects(a.SquareSet.lightSquares()),n=this.board[e].intersects(a.SquareSet.darkSquares()),o=this.board[i.opposite(e)].isDisjoint(a.SquareSet.lightSquares()),r=this.board[i.opposite(e)].isDisjoint(a.SquareSet.darkSquares());return t&&o||n&&r}return!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(){if(this.isVariantEnd()||this.isStalemate())return{winner:this.turn}}}n.Antichess=p;class f extends l.Chess{constructor(){super("kingofthehill")}static default(){return super.default()}static fromSetup(e){return super.fromSetup(e)}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.king.intersects(a.SquareSet.center())}variantOutcome(){for(const e of r.COLORS)if(this.board.pieces(e,"king").intersects(a.SquareSet.center()))return{winner:e}}}n.KingOfTheHill=f;class m extends l.Chess{constructor(){super("3check")}static default(){const e=super.default();return e.remainingChecks=u.RemainingChecks.default(),e}static fromSetup(e){return super.fromSetup(e).map(t=>(t.remainingChecks=e.remainingChecks?e.remainingChecks.clone():u.RemainingChecks.default(),t))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.board.pieces(e,"king").equals(this.board[e])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(){if(this.remainingChecks)for(const e of r.COLORS)if(this.remainingChecks[e]<=0)return{winner:e}}}n.ThreeCheck=m;class v extends l.Chess{constructor(){super("racingkings")}static default(){const e=new this;return e.board=c.Board.racingKings(),e.turn="white",e.castles=l.Castles.empty(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){return super.fromSetup(e).map(e=>(e.castles=l.Castles.empty(),e))}validate(){return this.board.pawn.nonEmpty()||this.isCheck()?o.Result.err(new l.PositionError(l.IllegalSetup.Variant)):super.validate()}clone(){return super.clone()}dests(e,t){if(e===t.king)return super.dests(e,t);let n=a.SquareSet.empty();for(const o of super.dests(e,t)){const t={from:e,to:o},r=this.clone();r.play(t),r.isCheck()||(n=n.with(o))}return n}hasInsufficientMaterial(e){return!1}isVariantEnd(){const e=a.SquareSet.fromRank(7),t=this.board.king.intersect(e);if(t.isEmpty())return!1;if("white"===this.turn||t.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(i.defined(n)){const t=this.board.occupied.without(n);for(const o of s.kingAttacks(n).intersect(e).diff(this.board.black))if(this.kingAttackers(o,i.opposite(this.turn),t).isEmpty())return!1}return!0}variantOutcome(){if(!this.isVariantEnd())return;const e=a.SquareSet.fromRank(7),t=this.board.pieces("black","king").intersects(e),n=this.board.pieces("white","king").intersects(e);return t&&!n?{winner:"black"}:n&&!t?{winner:"white"}:{winner:void 0}}}class g extends l.Chess{constructor(){super("horde")}static default(){const e=new this;return e.board=c.Board.horde(),e.pockets=void 0,e.turn="white",e.castles=l.Castles.default(),e.castles.discardSide("white"),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){return super.fromSetup(e)}validate(){if(this.board.occupied.isEmpty())return o.Result.err(new l.PositionError(l.IllegalSetup.Empty));if(!this.board.king.isSingleSquare())return o.Result.err(new l.PositionError(l.IllegalSetup.Kings));if(!this.board.king.diff(this.board.promoted).isSingleSquare())return o.Result.err(new l.PositionError(l.IllegalSetup.Kings));const e=this.board.kingOf(i.opposite(this.turn));if(i.defined(e)&&this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty())return o.Result.err(new l.PositionError(l.IllegalSetup.OppositeCheck));for(const t of r.COLORS)if(this.board.pieces(t,"pawn").intersects(a.SquareSet.backrank(i.opposite(t))))return o.Result.err(new l.PositionError(l.IllegalSetup.PawnsOnBackrank));return o.Result.ok(void 0)}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}n.Horde=g,n.defaultPosition=function(e){switch(e){case"chess":return l.Chess.default();case"antichess":return p.default();case"atomic":return h.default();case"horde":return g.default();case"racingkings":return v.default();case"kingofthehill":return f.default();case"3check":return m.default();case"crazyhouse":return d.default()}},n.setupPosition=function(e,t){switch(e){case"chess":return l.Chess.fromSetup(t);case"antichess":return p.fromSetup(t);case"atomic":return h.fromSetup(t);case"horde":return g.fromSetup(t);case"racingkings":return v.fromSetup(t);case"kingofthehill":return f.fromSetup(t);case"3check":return m.fromSetup(t);case"crazyhouse":return d.fromSetup(t)}}},{"./attacks":20,"./board":21,"./chess":22,"./setup":25,"./squareSet":26,"./types":27,"./util":28,"@badrap/result":1}],30:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./vnode"),r=e("./is");function i(e,t,n){var i,s,a,c={};if(void 0!==n?(c=t,r.array(n)?i=n:r.primitive(n)?s=n:n&&n.sel&&(i=[n])):void 0!==t&&(r.array(t)?i=t:r.primitive(t)?s=t:t&&t.sel?i=[t]:c=t),r.array(i))for(a=0;a<i.length;++a)r.primitive(i[a])&&(i[a]=o.vnode(void 0,void 0,void 0,i[a]));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||function e(t,n,o){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==o&&void 0!==n)for(var r=0;r<n.length;++r){var i=n[r].data;void 0!==i&&e(i,n[r].children,n[r].sel)}}(c,i,e),o.vnode(e,c,i,s,void 0)}n.h=i,n.default=i},{"./is":32,"./vnode":37}],31:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.htmlDomApi={createElement:function(e){return document.createElement(e)},createElementNS:function(e,t){return document.createElementNS(e,t)},createTextNode:function(e){return document.createTextNode(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType}},n.default=n.htmlDomApi},{}],32:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.array=Array.isArray,n.primitive=function(e){return"string"==typeof e||"number"==typeof e}},{}],33:[function(e,t,n){"use strict";function o(e,t){var n,o=t.elm,r=e.data.attrs,i=t.data.attrs;if((r||i)&&r!==i){for(n in r=r||{},i=i||{}){var s=i[n];r[n]!==s&&(!0===s?o.setAttribute(n,""):!1===s?o.removeAttribute(n):o.setAttribute(n,s))}for(n in r)n in i||o.removeAttribute(n)}}Object.defineProperty(n,"__esModule",{value:!0}),n.attributesModule={create:o,update:o},n.default=n.attributesModule},{}],34:[function(e,t,n){"use strict";function o(e,t){var n,o,r=t.elm,i=e.data.class,s=t.data.class;if((i||s)&&i!==s){for(o in s=s||{},i=i||{})s[o]||r.classList.remove(o);for(o in s)(n=s[o])!==i[o]&&r.classList[n?"add":"remove"](o)}}Object.defineProperty(n,"__esModule",{value:!0}),n.classModule={create:o,update:o},n.default=n.classModule},{}],35:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./vnode"),r=e("./is"),i=e("./htmldomapi");function s(e){return void 0===e}function a(e){return void 0!==e}var c=o.default("",{},[],void 0,void 0);function u(e,t){return e.key===t.key&&e.sel===t.sel}function l(e,t,n){var o,r,i,s={};for(o=t;o<=n;++o)null!=(i=e[o])&&void 0!==(r=i.key)&&(s[r]=o);return s}var d=["create","update","remove","destroy","pre","post"],h=e("./h");n.h=h.h;var p=e("./thunk");n.thunk=p.thunk,n.init=function(e,t){var n,h,p={},f=void 0!==t?t:i.default;for(n=0;n<d.length;++n)for(p[d[n]]=[],h=0;h<e.length;++h){var m=e[h][d[n]];void 0!==m&&p[d[n]].push(m)}function v(e,t){return function(){if(0==--t){var n=f.parentNode(e);f.removeChild(n,e)}}}function g(e,t){var n,o=e.data;void 0!==o&&a(n=o.hook)&&a(n=n.init)&&(n(e),o=e.data);var i=e.children,s=e.sel;if(void 0!==s){var u=s.indexOf("#"),l=s.indexOf(".",u),d=u>0?u:s.length,h=l>0?l:s.length,m=-1!==u||-1!==l?s.slice(0,Math.min(d,h)):s,v=e.elm=a(o)&&a(n=o.ns)?f.createElementNS(n,m):f.createElement(m);for(d<h&&v.setAttribute("id",s.slice(d+1,h)),l>0&&v.setAttribute("class",s.slice(h+1).replace(/\./g," ")),n=0;n<p.create.length;++n)p.create[n](c,e);if(r.array(i))for(n=0;n<i.length;++n){var b=i[n];null!=b&&f.appendChild(v,g(b,t))}else r.primitive(e.text)&&f.appendChild(v,f.createTextNode(e.text));a(n=e.data.hook)&&(n.create&&n.create(c,e),n.insert&&t.push(e))}else e.elm=f.createTextNode(e.text);return e.elm}function b(e,t,n,o,r,i){for(;o<=r;++o){var s=n[o];null!=s&&f.insertBefore(e,g(s,i),t)}}function k(e){var t,n,o=e.data;if(void 0!==o){for(a(t=o.hook)&&a(t=t.destroy)&&t(e),t=0;t<p.destroy.length;++t)p.destroy[t](e);if(void 0!==e.children)for(n=0;n<e.children.length;++n)null!=(t=e.children[n])&&"string"!=typeof t&&k(t)}}function w(e,t,n,o){for(;n<=o;++n){var r=void 0,i=void 0,s=void 0,c=t[n];if(null!=c)if(a(c.sel)){for(k(c),i=p.remove.length+1,s=v(c.elm,i),r=0;r<p.remove.length;++r)p.remove[r](c,s);a(r=c.data)&&a(r=r.hook)&&a(r=r.remove)?r(c,s):s()}else f.removeChild(e,c.elm)}}function y(e,t,n){var o,r;a(o=t.data)&&a(r=o.hook)&&a(o=r.prepatch)&&o(e,t);var i=t.elm=e.elm,c=e.children,d=t.children;if(e!==t){if(void 0!==t.data){for(o=0;o<p.update.length;++o)p.update[o](e,t);a(o=t.data.hook)&&a(o=o.update)&&o(e,t)}s(t.text)?a(c)&&a(d)?c!==d&&function(e,t,n,o){for(var r,i,a,c=0,d=0,h=t.length-1,p=t[0],m=t[h],v=n.length-1,k=n[0],S=n[v];c<=h&&d<=v;)null==p?p=t[++c]:null==m?m=t[--h]:null==k?k=n[++d]:null==S?S=n[--v]:u(p,k)?(y(p,k,o),p=t[++c],k=n[++d]):u(m,S)?(y(m,S,o),m=t[--h],S=n[--v]):u(p,S)?(y(p,S,o),f.insertBefore(e,p.elm,f.nextSibling(m.elm)),p=t[++c],S=n[--v]):u(m,k)?(y(m,k,o),f.insertBefore(e,m.elm,p.elm),m=t[--h],k=n[++d]):(void 0===r&&(r=l(t,c,h)),s(i=r[k.key])?(f.insertBefore(e,g(k,o),p.elm),k=n[++d]):((a=t[i]).sel!==k.sel?f.insertBefore(e,g(k,o),p.elm):(y(a,k,o),t[i]=void 0,f.insertBefore(e,a.elm,p.elm)),k=n[++d]));c>h?b(e,null==n[v+1]?null:n[v+1].elm,n,d,v,o):d>v&&w(e,t,c,h)}(i,c,d,n):a(d)?(a(e.text)&&f.setTextContent(i,""),b(i,null,d,0,d.length-1,n)):a(c)?w(i,c,0,c.length-1):a(e.text)&&f.setTextContent(i,""):e.text!==t.text&&f.setTextContent(i,t.text),a(r)&&a(o=r.postpatch)&&o(e,t)}}return function(e,t){var n,r,i,s=[];for(n=0;n<p.pre.length;++n)p.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=function(e){var t=e.id?"#"+e.id:"",n=e.className?"."+e.className.split(" ").join("."):"";return o.default(f.tagName(e).toLowerCase()+t+n,{},[],void 0,e)}(e)),u(e,t)?y(e,t,s):(r=e.elm,i=f.parentNode(r),g(t,s),null!==i&&(f.insertBefore(i,t.elm,f.nextSibling(r)),w(i,[e],0,0))),n=0;n<s.length;++n)s[n].data.hook.insert(s[n]);for(n=0;n<p.post.length;++n)p.post[n]();return t}}},{"./h":30,"./htmldomapi":31,"./is":32,"./thunk":36,"./vnode":37}],36:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=e("./h");function r(e,t){t.elm=e.elm,e.data.fn=t.data.fn,e.data.args=t.data.args,t.data=e.data,t.children=e.children,t.text=e.text,t.elm=e.elm}function i(e){var t=e.data;r(t.fn.apply(void 0,t.args),e)}function s(e,t){var n,o=e.data,i=t.data,s=o.args,a=i.args;if(o.fn===i.fn&&s.length===a.length){for(n=0;n<a.length;++n)if(s[n]!==a[n])return void r(i.fn.apply(void 0,a),t);r(e,t)}else r(i.fn.apply(void 0,a),t)}n.thunk=function(e,t,n,r){return void 0===r&&(r=n,n=t,t=void 0),o.h(e,{key:t,hook:{init:i,prepatch:s},fn:n,args:r})},n.default=n.thunk},{"./h":30}],37:[function(e,t,n){"use strict";function o(e,t,n,o,r){return{sel:e,data:t,children:n,text:o,elm:r,key:void 0===t?void 0:t.key}}Object.defineProperty(n,"__esModule",{value:!0}),n.vnode=o,n.default=o},{}],38:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./pool"),r=e("common"),i=e("common/storage"),s=e("common/throttle"),a=e("./winningChances"),c=window.lichess;function u(e,t){return!!t.startsWith("O-O")||"crazyhouse"!==e&&(!!t.includes("x")||(t.toLowerCase()===t||"threeCheck"===e&&t.includes("+")))}function l(e){return"standard"===e||"chess960"===e}function d(e,t){if(!function(){const e=["x86_64","x86-64","Win64","x64","amd64","AMD64"];for(const t of e)if(navigator.userAgent.includes(t))return!0;return"Linux x86_64"===navigator.platform||"MacIntel"===navigator.platform}())return;if("object"!=typeof Atomics)return;if("function"!=typeof SharedArrayBuffer)return;const n=new WebAssembly.Memory({shared:!0,initial:e,maximum:t});if(n.buffer instanceof SharedArrayBuffer){try{window.postMessage(n,"*")}catch(o){return}return n}}n.default=function(e){const t=t=>e.storageKeyPrefix?`${e.storageKeyPrefix}.${t}`:t;let n="asmjs",h=!1;if("object"==typeof WebAssembly&&WebAssembly.validate(Uint8Array.of(0,97,115,109,1,0,0,0))&&(n="wasm",l(e.variant.key))){const e=d(8,16);if(e){n="wasmx";try{e.grow(8),h=!0}catch(N){}}}const p=Math.min(Math.max((navigator.hardwareConcurrency||1)-1,1),h?16:2),f=i.storedProp(t("ceval.threads"),Math.min(Math.ceil((navigator.hardwareConcurrency||1)/4),p)),m=Math.min(1024*(navigator.deviceMemory||.25)/8,h?1024:16),v=i.storedProp(t("ceval.hash-size"),16),g=i.storedProp(t("ceval.max-depth"),18),b=i.storedProp(t("ceval.multipv"),e.multiPvDefault||1),k=i.storedProp("ceval.infinite",!1);let w=null;const y=c.storage.makeBoolean(t("client-eval-enabled")),S=r.prop(!0),P=r.prop(e.possible&&S()&&y.get()&&!document.hidden);let C=!1,q=!1;const M=r.prop(null),E=r.prop(!1),O=new o.Pool({technology:n,asmjs:"vendor/stockfish.js/stockfish.js",wasm:"vendor/stockfish.js/stockfish.wasm.js",wasmx:l(e.variant.key)?"vendor/stockfish.wasm/stockfish.js":"vendor/stockfish-mv.wasm/stockfish.js"},{minDepth:6,variant:e.variant.key,threads:"wasmx"==n&&(()=>Math.min(parseInt(f()),p)),hashSize:"wasmx"==n&&(()=>Math.min(parseInt(v()),m))}),_=function(){const e=[];return function(t){if(function(e){return e.knps&&e.depth>=16&&void 0!==e.cp&&Math.abs(e.cp)<500&&e.fen.split(/\s/)[0].split(/[nbrqkp]/i).length-1>=10}(t)&&(e.push(t.knps),e.length>9)){let t=18,n=function(e){e.sort((e,t)=>e-t);const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(e)||0;n>100&&(t=19),n>150&&(t=20),n>250&&(t=21),n>500&&(t=22),n>1e3&&(t=23),n>2e3&&(t=24),n>3500&&(t=25),n>5e3&&(t=26),n>7e3&&(t=27),g(t),e.length>40&&e.shift()}}}();let x=null;const R=s.default(200,(t,n)=>{z(t.pvs,n.ply%2==(n.threatMode?1:0)?"white":"black"),_(t),w=t,e.emit(t,n),t.fen!==x&&(x=t.fen,c.storage.fire("ceval.fen",t.fen))}),A=()=>E()||k()?99:parseInt(g()),z=(e,t)=>e.sort((function(e,n){return a.povChances(t,n)-a.povChances(t,e)})),T=(t,n,o,r)=>{if(!P()||!e.possible)return;E(r);const i=A(),s=n[n.length-1],a=o?s.threat:s.ceval;if(a&&a.depth>=i)return;const c={initialFen:n[0].fen,moves:[],currentFen:s.fen,path:t,ply:s.ply,maxDepth:i,multiPv:parseInt(b()),threatMode:o,emit(e){P()&&R(e,c)}};if(o){const e=s.ply%2==1?"w":"b",t=s.fen.replace(/ (w|b) /," "+e+" ");c.currentFen=t,c.initialFen=t}else for(let l=1;l<n.length;l++){let t=n[l];u(e.variant.key,t.san)?(c.moves=[],c.initialFen=t.fen):c.moves.push(t.uci)}O.start(c),C={path:t,steps:n,threatMode:o}};function D(){P()&&C&&(O.stop(),q=C,C=!1)}return P()&&(c.storage.fire("ceval.fen","start"),c.storage.make("round.ongoing").listen(t=>{P(!1),e.redraw()})),{technology:n,start:T,stop:D,allowed:S,possible:e.possible,enabled:P,multiPv:b,threads:"wasmx"==n?f:void 0,hashSize:"wasmx"==n?v:void 0,maxThreads:p,maxHashSize:m,infinite:k,hovering:M,setHovering(t,n){M(n?{fen:t,uci:n}:null),e.setAutoShapes()},toggle(){e.possible&&S()&&(D(),P(!P()),"hidden"!==document.visibilityState&&y.set(P()))},curDepth:()=>w?w.depth:0,effectiveMaxDepth:A,variant:e.variant,isDeeper:E,goDeeper:function(){const e=C||q;e&&(D(),T(e.path,e.steps,e.threatMode,!0))},canGoDeeper:()=>!E()&&!k()&&!O.isComputing(),isComputing:()=>!!C&&O.isComputing(),engineName:O.engineName,destroy:O.destroy,redraw:e.redraw}}},{"./pool":40,"./winningChances":43,common:46,"common/storage":50,"common/throttle":52}],39:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./ctrl");n.ctrl=o.default;const r=e("./view");n.view=r;const i=e("./winningChances");n.winningChances=i,n.isEvalBetter=function(e,t){return!t||e.depth>t.depth||e.depth===t.depth&&e.nodes>t.nodes},window.lichess.storage.make("ceval.pool.start").listen(e=>{const t=document.getElementById("analyse-toggle-ceval");t&&t.checked&&t.click()})},{"./ctrl":38,"./view":42,"./winningChances":43}],40:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("common/sync"),r=e("./stockfishProtocol");class i{constructor(e,t,n){this.url=e,this.poolOpts=t,this.workerOpts=n,this.isComputing=()=>!!this.protocol.sync&&this.protocol.sync.isComputing(),this.engineName=()=>this.protocol.sync&&this.protocol.sync.engineName,this.protocol=o.sync(this.boot())}stop(){return this.protocol.promise.then(e=>e.stop())}start(e){return this.protocol.promise.then(t=>t.stop().then(()=>t.start(e)))}}n.AbstractWorker=i;class s extends i{boot(){this.worker=new Worker(window.lichess.assetUrl(this.url,{sameDomain:!0}));const e=new r.default(this.send.bind(this),this.workerOpts);return this.worker.addEventListener("message",t=>{e.received(t.data)},!0),Promise.resolve(e)}start(e){return this.protocol.promise.then(t=>{const n=new Promise((e,t)=>setTimeout(t,1e3));return Promise.race([t.stop(),n]).catch(()=>{this.destroy(),this.protocol=o.sync(this.boot())}).then(()=>this.protocol.promise.then(t=>t.start(e)))})}destroy(){this.worker.terminate()}send(e){this.worker.postMessage(e)}}class a extends i{boot(){return a.global||(a.global=window.lichess.loadScript(this.url,{sameDomain:!0}).then(()=>{const e=this.instance=window.Stockfish(),t=new r.default(this.send.bind(this),this.workerOpts),n=t.received.bind(t);return e.addMessageListener(n),{instance:e,protocol:t}})),a.global.then(e=>(this.instance=e.instance,e.protocol))}destroy(){a.global&&(console.log("stopping singleton wasmx worker (instead of destroying) ..."),this.stop().then(()=>console.log("... successfully stopped")))}send(e){this.instance&&this.instance.postMessage(e)}}n.Pool=class{constructor(e,t){this.poolOpts=e,this.protocolOpts=t,this.workers=[],this.token=0,this.warmup=()=>{if(!this.workers.length)if("wasmx"==this.poolOpts.technology)this.workers.push(new a(this.poolOpts.wasmx,this.poolOpts,this.protocolOpts));else for(let e=1;e<=2;e++)this.workers.push(new s("wasm"==this.poolOpts.technology?this.poolOpts.wasm:this.poolOpts.asmjs,this.poolOpts,this.protocolOpts))},this.stop=()=>this.workers.forEach(e=>e.stop()),this.destroy=()=>{this.stop(),this.workers.forEach(e=>e.destroy())},this.start=e=>{window.lichess.storage.fire("ceval.pool.start"),this.getWorker().then((function(t){t.start(e)})).catch((function(e){console.log(e),setTimeout(()=>window.lichess.reload(),1e4)}))},this.isComputing=()=>!!this.workers.length&&this.workers[this.token].isComputing(),this.engineName=()=>this.workers[this.token]&&this.workers[this.token].engineName()}getWorker(){return this.warmup(),new Promise((e,t)=>{const n=this.workers[this.token];n.stop().then(()=>e(n)),setTimeout(t,50)}).catch(()=>(this.token=(this.token+1)%this.workers.length,Promise.resolve(this.workers[this.token])))}}},{"./stockfishProtocol":41,"common/sync":51}],41:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("chess"),r=new RegExp(""+/^info depth (\d+) seldepth \d+ multipv (\d+) /.source+/score (cp|mate) ([-\d]+) /.source+/(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source+/(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source+/pv (.+)/.source);function i(){const e={};return e.promise=new Promise((function(t,n){e.resolve=t,e.reject=n})),e}n.default=class{constructor(e,t){this.send=e,this.opts=t,this.work=null,this.curEval=null,this.expectedPvs=1,this.stopped=i(),this.stopped.resolve(),this.send("uci"),this.setOption("UCI_AnalyseMode","true"),this.setOption("Analysis Contempt","Off"),"fromPosition"===t.variant||"chess960"===t.variant?this.setOption("UCI_Chess960","true"):"antichess"===t.variant?this.setOption("UCI_Variant","giveaway"):"standard"!==t.variant&&this.setOption("UCI_Variant",o.variantToRules(t.variant))}setOption(e,t){this.send(`setoption name ${e} value ${t}`)}received(e){if(e.startsWith("id name "))this.engineName=e.substring("id name ".length);else if(e.startsWith("bestmove "))return this.stopped||(this.stopped=i()),this.stopped.resolve(),void(this.work&&this.curEval&&this.work.emit(this.curEval));if(!this.work)return;let t=e.match(r);if(!t)return;let n=parseInt(t[1]),o=parseInt(t[2]),s="mate"===t[3],a=parseInt(t[4]),c=t[5],u=parseInt(t[6]),l=parseInt(t[7]),d=t[8].split(" ");if(s&&!a)return;if(this.expectedPvs<o&&(this.expectedPvs=o),n<this.opts.minDepth)return;let h=this.work.threatMode?0:1;if(this.work.ply%2===h&&(a=-a),c&&1===o)return;let p={moves:d,cp:s?void 0:a,mate:s?a:void 0,depth:n};1===o?this.curEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:n,knps:u/l,nodes:u,cp:s?void 0:a,mate:s?a:void 0,pvs:[p],millis:l}:this.curEval&&(this.curEval.pvs.push(p),this.curEval.depth=Math.min(this.curEval.depth,n)),o===this.expectedPvs&&this.curEval&&this.work.emit(this.curEval)}start(e){this.stopped?(this.work=e,this.curEval=null,this.stopped=null,this.expectedPvs=1,this.opts.threads&&this.setOption("Threads",this.opts.threads()),this.opts.hashSize&&this.setOption("Hash",this.opts.hashSize()),this.setOption("MultiPV",this.work.multiPv),this.send(["position","fen",this.work.initialFen,"moves"].concat(this.work.moves).join(" ")),this.work.maxDepth>=99?this.send("go depth 99"):this.send("go movetime 90000 depth "+this.work.maxDepth)):console.log("ceval: tried to start analysing before requesting stop")}stop(){return this.stopped||(this.work=null,this.stopped=i(),this.send("stop")),this.stopped.promise}isComputing(){return!this.stopped}}},{chess:44}],42:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./winningChances"),r=e("common"),i=e("chess"),s=e("snabbdom"),a=e("chessops/util"),c=e("chessops/fen"),u=e("chessops/san"),l=e("chessops/variant");let d=0;const h=[...Array(8).keys()].map(e=>s.h(3===e?"tick.zero":"tick",{attrs:{style:`height: ${12.5*(e+1)}%`}}));function p(e,t){const n=e.getCeval(),o=e.trans;if(!t.client)return[t.server&&e.nextNodeBest()?o.noarg("usingServerAnalysis"):o.noarg("loadingEngine")];const r=t.client.cloud?[o("depthX",t.client.depth||0),s.h("span.cloud",{attrs:{title:o.noarg("cloudAnalysis")}},"Cloud")]:[o("depthX",(t.client.depth||0)+"/"+t.client.maxDepth)];return n.canGoDeeper()?r.push(s.h("a.deeper",{attrs:{title:o.noarg("goDeeper"),"data-icon":"O"},hook:{insert:e=>e.elm.addEventListener("click",()=>{n.goDeeper(),n.redraw()})}})):!t.client.cloud&&t.client.knps&&r.push(", "+Math.round(t.client.knps)+" knodes/s"),r}function f(e,t){if(!t)return e.trans.noarg("loadingEngine");let n=e.trans("depthX",(t.depth||0)+"/"+t.maxDepth);return t.knps&&(n+=", "+Math.round(t.knps)+" knodes/s"),n}function m(e){return e.disableThreatMode&&e.disableThreatMode()?null:s.h("a.show-threat",{class:{active:e.threatMode(),hidden:!!e.getNode().check},attrs:{"data-icon":"7",title:e.trans.noarg("showThreat")+" (x)"},hook:{insert:t=>t.elm.addEventListener("click",e.toggleThreatMode)}})}function v(e){const t=e.engineName();return[s.h("span",t?{attrs:{title:t}}:{},"wasmx"==e.technology?window.lichess.engineName:"Stockfish 10+"),"wasmx"==e.technology?s.h("span.native",{attrs:{title:"Multi-threaded WebAssembly (experimental)"}},"wasmx"):"wasm"==e.technology?s.h("span.native",{attrs:{title:"WebAssembly"}},"wasm"):s.h("span.asmjs",{attrs:{title:"JavaScript fallback"}},"asmjs")]}const g=4e6;function b(e){const t=e.server,n=e.client;return t?n&&(n.nodes>g||void 0!==n.mate&&(void 0===t.mate||Math.abs(n.mate)<Math.abs(t.mate)))?n:t:n}function k(e){return e.getAttribute("data-fen")}function w(e){return $(e.target).closest("div.pv").attr("data-uci")}function y(e,t){window.lichess.requestIdleCallback(()=>{t.setHovering(k(e),$(e).find("div.pv:hover").attr("data-uci"))})}n.getBestEval=b,n.renderGauge=function(e){if(e.ongoing||!e.showEvalGauge())return;let t,n=b(e.currentEvals());return n?(t=o.povChances("white",n),d=t):t=d,s.h("div.eval-gauge",{class:{empty:null===t,reverse:"black"===e.getOrientation()}},[s.h("div.black",{attrs:{style:`height: ${100-50*(t+1)}%`}}),...h])},n.renderCeval=function(e){const t=e.getCeval(),n=e.trans;if(!t.allowed()||!t.possible||!e.showComputer())return;const o=t.enabled(),a=e.currentEvals(),c=e.threatMode(),u=c&&e.getNode().threat,l=u||b(a);let d,h;l&&void 0!==l.cp?(d=i.renderEval(l.cp),h=a.client?Math.min(100,Math.round(100*a.client.depth/(a.client.maxDepth||t.effectiveMaxDepth()))):0):l&&r.defined(l.mate)?(d="#"+l.mate,h=100):e.gameOver()?(d="-",h=0):(d=o?s.h("i.ddloader"):s.h("i"),h=0),c&&(h=u?Math.min(100,Math.round(100*u.depth/u.maxDepth)):0);const g=o?s.h("div.bar",s.h("span",{class:{threat:c},attrs:{style:`width: ${h}%`},hook:{postpatch:(e,t)=>{if(e.data.percent>h||!!e.data.threatMode!=c){const e=t.elm,n=e.parentNode;n.removeChild(e),n.appendChild(e)}t.data.percent=h,t.data.threatMode=c}}})):null,k=o?[s.h("pearl",[d]),s.h("div.engine",[...c?[n.noarg("showThreat")]:v(t),s.h("span.info",e.gameOver()?[n.noarg("gameOver")]:c?[f(e,u)]:p(e,a))])]:[d?s.h("pearl",[d]):null,s.h("help",[...v(t),s.h("br"),n.noarg("inLocalBrowser")])],w=e.mandatoryCeval&&e.mandatoryCeval()?null:s.h("div.switch",{attrs:{title:n.noarg("toggleLocalEvaluation")+" (l)"}},[s.h("input#analyse-toggle-ceval.cmn-toggle.cmn-toggle--subtle",{attrs:{type:"checkbox",checked:o},hook:{insert:t=>t.elm.addEventListener("change",e.toggleCeval)}}),s.h("label",{attrs:{for:"analyse-toggle-ceval"}})]);return s.h("div.ceval"+(o?".enabled":""),{class:{computing:h<100&&t.isComputing()}},[g,...k,m(e),w])},n.renderPvs=function(e){const t=e.getCeval();if(!t.allowed()||!t.possible||!t.enabled())return;const n=parseInt(t.multiPv()),o=e.getNode(),d=c.parseFen(o.fen).unwrap();let h,p=!1;e.threatMode()&&o.threat?(h=o.threat.pvs,p=!0):h=o.ceval?o.ceval.pvs:[],p&&(d.turn=a.opposite(d.turn));const f=l.setupPosition(i.variantToRules(t.variant.key),d);return s.h("div.pv_box",{attrs:{"data-fen":o.fen},hook:{insert:n=>{const o=n.elm;o.addEventListener("mouseover",e=>{t.setHovering(k(o),w(e))}),o.addEventListener("mouseout",()=>{t.setHovering(k(o))}),o.addEventListener("mousedown",t=>{const n=w(t);n&&e.playUci(n)}),y(o,t)},postpatch:(e,n)=>y(n.elm,t)}},[...Array(n).keys()].map((function(e){return h[e]?s.h("div.pv",p?{}:{attrs:{"data-uci":h[e].moves[0]}},[n>1?s.h("strong",r.defined(h[e].mate)?"#"+h[e].mate:i.renderEval(h[e].cp)):null,s.h("span",f.unwrap(t=>u.makeSanVariation(t,h[e].moves.slice(0,12).map(e=>a.parseUci(e))),e=>"--"))]):s.h("div.pv")})))}},{"./winningChances":43,chess:44,"chessops/fen":23,"chessops/san":24,"chessops/util":28,"chessops/variant":29,common:46,snabbdom:35}],43:[function(e,t,n){"use strict";function o(e){return 2/(1+Math.exp(-.004*e))-1}function r(e){return void 0!==e.mate?(n=e.mate,o(100*(21-Math.min(10,Math.abs(n)))*(n>0?1:-1))):(t=e.cp,o(Math.min(Math.max(-1e3,t),1e3)));var t,n}function i(e,t){return function(e,t){return"white"===e?t:-t}(e,r(t))}Object.defineProperty(n,"__esModule",{value:!0}),n.povChances=i,n.povDiff=function(e,t,n){return(i(e,t)-i(e,n))/2}},{}],44:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./piotr");n.piotr=o.default,n.initialFen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",n.fixCrazySan=function(e){return"P"===e[0]?e.slice(1):e},n.decomposeUci=function(e){return[e.slice(0,2),e.slice(2,4),e.slice(4,5)]},n.renderEval=function(e){return((e=Math.max(Math.min(Math.round(e/10)/10,99),-99))>0?"+":"")+e},n.readDests=function(e){if(void 0===e)return null;const t={};return e&&e.split(" ").forEach(e=>{t[o.default[e[0]]]=e.slice(1).split("").map(e=>o.default[e])}),t},n.readDrops=function(e){return null==e?null:e.match(/.{2}/g)||[]},n.roleToSan={pawn:"P",knight:"N",bishop:"B",rook:"R",queen:"Q",king:"K"},n.sanToRole={P:"pawn",N:"knight",B:"bishop",R:"rook",Q:"queen",K:"king"},n.variantToRules=function(e){switch(e){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return e}}},{"./piotr":45}],45:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.default={a:"a1",b:"b1",c:"c1",d:"d1",e:"e1",f:"f1",g:"g1",h:"h1",i:"a2",j:"b2",k:"c2",l:"d2",m:"e2",n:"f2",o:"g2",p:"h2",q:"a3",r:"b3",s:"c3",t:"d3",u:"e3",v:"f3",w:"g3",x:"h3",y:"a4",z:"b4",A:"c4",B:"d4",C:"e4",D:"f4",E:"g4",F:"h4",G:"a5",H:"b5",I:"c5",J:"d5",K:"e5",L:"f5",M:"g5",N:"h5",O:"a6",P:"b6",Q:"c6",R:"d6",S:"e6",T:"f6",U:"g6",V:"h6",W:"a7",X:"b7",Y:"c7",Z:"d7",0:"e7",1:"f7",2:"g7",3:"h7",4:"a8",5:"b8",6:"c8",7:"d8",8:"e8",9:"f8","!":"g8","?":"h8"}},{}],46:[function(e,t,n){"use strict";function o(e){return void 0!==e}Object.defineProperty(n,"__esModule",{value:!0}),n.defined=o,n.empty=function(e){return!e||0===e.length},n.prop=function(e){let t=e;return function(e){return o(e)&&(t=e),t}}},{}],47:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./throttle");let r;n.runner=function(e,t=100){let n;const r=o.default(t,()=>{window.lichess.raf(()=>{e(),n&&clearTimeout(n),n=setTimeout(r,500)})});r()},n.fixMainBoardHeight=function(e){const t=e.querySelector(".main-board"),n=t.offsetWidth;r!=n&&(r=n,t.style.height=n+"px",t.querySelector(".cg-wrap").style.height=n+"px",window.lichess.dispatchEvent(document.body,"chessground.resize"))};let i=!1;n.bindChessgroundResizeOnce=function(e){i||(i=!0,document.body.addEventListener("chessground.resize",e))},n.needsBoardHeightFix=function(){if(window.chrome)return!1;const e=navigator.userAgent.split("Firefox/");return!e[1]||parseInt(e[1])<61}},{"./throttle":52}],48:[function(e,t,n){"use strict";
/*!
 * hoverIntent v1.10.0 // 2019.02.25 // jQuery v1.7.0+
 * http://briancherne.github.io/jquery-hoverIntent/
 *
 * You may use hoverIntent under the terms of the MIT license. Basically that
 * means you are free to use hoverIntent as long as this header is left intact.
 * Copyright 2007-2019 Brian Cherne
 */Object.defineProperty(n,"__esModule",{value:!0}),n.menuHover=()=>window.lichess.raf((function(){if(window.lichess.hasTouchEvents)return;let e,t,n=function(n){e=n.pageX,t=n.pageY},o={};$("#topnav.hover").each((function(){const r=$(this).removeClass("hover"),i=()=>r.toggleClass("hover"),s=function(){Math.sqrt((o.pX-e)*(o.pX-e)+(o.pY-t)*(o.pY-t))<10?(r.off(o.event,n),delete o.timeoutId,o.isActive=!0,i()):(o.pX=e,o.pY=t,o.timeoutId=setTimeout(s,100))};var a=function(e){o.timeoutId&&(o.timeoutId=clearTimeout(o.timeoutId));var t=o.event="mousemove";if("mouseenter"==e.type){if(o.isActive||e.originalEvent.buttons)return;o.pX=e.pageX,o.pY=e.pageY,r.off(t,n).on(t,n),o.timeoutId=setTimeout(s,100)}else{if(!o.isActive)return;r.off(t,n),o={},i()}};r.on("mouseenter",a).on("mouseleave",a)}))}))},{}],49:[function(e,t,n){"use strict";function o(e){return e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.touches&&e.targetTouches[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0}Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e,t,n,r){if(!t)return;const i=document.createElement("cg-resize");e.container.appendChild(i);const s=e=>{e.preventDefault();const t="touchstart"===e.type?"touchmove":"mousemove",n="touchstart"===e.type?"touchend":"mouseup",r=o(e),i=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let s=i;const a=window.lichess.debounce(()=>{$.ajax({method:"post",url:"/pref/zoom?v="+(100+s)})},700),c=e=>{const t=o(e),n=t[0]-r[0]+t[1]-r[1];s=Math.round(Math.min(100,Math.max(0,i+n/10))),document.body.setAttribute("style","--zoom:"+s),window.lichess.dispatchEvent(window,"resize"),a()};document.body.classList.add("resizing"),document.addEventListener(t,c),document.addEventListener(n,()=>{document.removeEventListener(t,c),document.body.classList.remove("resizing")},{once:!0})};if(i.addEventListener("touchstart",s),i.addEventListener("mousedown",s),1==t){const e=e=>i.classList.toggle("none",r?!r(e):e>=2);e(n),window.lichess.pubsub.on("ply",e)}!function(e){const t=window.lichess.storage.makeBoolean("resize-nag");if(t.get())return;window.lichess.loadCssPath("nag-circle"),e.title="Drag to resize",e.innerHTML='<div class="nag-circle"></div>';for(const n of["touchstart","mousedown"])e.addEventListener(n,()=>{t.set(!0),e.innerHTML=""},{once:!0});setTimeout(()=>t.set(!0),15e3)}(i)}},{}],50:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./common"),r=window.lichess.storage;n.storedProp=function(e,t){const n="analyse."+e,i=!0===t||!1===t;let s;return function(e){return o.defined(e)&&e!=s?(s=e+"",r.set(n,e)):o.defined(s)||(s=r.get(n),null===s&&(s=t+"")),i?"true"===s:s}},n.storedJsonProp=function(e,t){return function(n){if(o.defined(n))return r.set(e,JSON.stringify(n)),n;const i=JSON.parse(r.get(e));return null!==i?i:t}}},{"./common":46}],51:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sync=function(e){const t={sync:void 0,promise:e.then(e=>(t.sync=e,e))};return t}},{}],52:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e,t){let n,o=0;return function(...r){const i=this,s=performance.now()-o;function a(){n=void 0,o=performance.now(),t.apply(i,r)}n&&clearTimeout(n),s>e?a():n=setTimeout(a,e-s)}}},{}],53:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("ceval"),r=e("chess"),i=e("chessground/util");function s(e,t,n){const o=r.decomposeUci(e);return[{orig:o[0],dest:o[1],brush:t,modifiers:n}]}n.default=function(e){const t=e.vm.node,n=e.ceval.hovering(),r=e.ground.state.movable.color;let a=[];if(n&&n.fen===t.fen&&(a=a.concat(s(n.uci,"paleBlue"))),e.vm.showAutoShapes()&&e.vm.showComputer()&&(t.eval&&(a=a.concat(s(t.eval.best,"paleGreen"))),!n)){let n=e.nextNodeBest;!n&&e.ceval.enabled()&&t.ceval&&(n=t.ceval.pvs[0].moves[0]),n&&(a=a.concat(s(n,"paleBlue"))),e.ceval.enabled()&&t.ceval&&t.ceval.pvs&&t.ceval.pvs[1]&&!(e.threatMode&&t.threat&&t.threat.pvs[2])&&t.ceval.pvs.forEach((function(e){if(e.moves[0]!==n){var i=o.winningChances.povDiff(r,t.ceval.pvs[0],e);i>.2||isNaN(i)||i<0||(a=a.concat(s(e.moves[0],"paleGrey",{lineWidth:Math.round(12-50*i)})))}}))}return e.ceval.enabled()&&e.threatMode&&t.threat&&(t.threat.pvs[1]?(a=a.concat(s(t.threat.pvs[0].moves[0],"paleRed")),t.threat.pvs.slice(1).forEach((function(e){const n=o.winningChances.povDiff(i.opposite(r),e,t.threat.pvs[0]);n>.2||isNaN(n)||n<0||(a=a.concat(s(e.moves[0],"paleRed",{lineWidth:Math.round(11-45*n)})))}))):a=a.concat(s(t.threat.pvs[0].moves[0],"red"))),a}},{ceval:39,chess:44,"chessground/util":18}],54:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("tree");n.canGoForward=function(e){return e.vm.node.children.length>0},n.next=function(e){var t=e.vm.node.children[0];t&&e.userJump(e.vm.path+t.id)},n.prev=function(e){e.userJump(o.path.init(e.vm.path))},n.last=function(e){var t=!o.path.contains(e.vm.path,e.vm.initialPath);e.userJump(t?e.vm.initialPath:o.path.fromNodeList(e.vm.mainline))},n.first=function(e){var t=e.vm.path!==e.vm.initialPath&&o.path.contains(e.vm.path,e.vm.initialPath);e.userJump(t?e.vm.initialPath:o.path.root)}},{tree:74}],55:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("tree"),r=e("ceval"),i=e("chess"),s=e("chessground/util"),a=e("./keyboard"),c=e("./socket"),u=e("./moveTest"),l=e("./solution"),d=e("./promotion"),h=e("./autoShape"),p=e("common"),f=e("common/storage"),m=e("common/throttle"),v=e("./xhr"),g=e("./speech"),b=e("./sound");n.default=function(e,t){let n={};var k,w,y,S;const P=p.prop(void 0),C=p.prop(!1);function q(e){n.path=e,n.nodeList=w.getNodeList(e),n.node=o.ops.last(n.nodeList),n.mainline=o.ops.mainlineNodeList(w.root)}function M(e){const t=P();if(t)return e(t)}function E(e){k=e,w=o.build(o.ops.reconstruct(k.game.treeParts));var i=o.path.fromNodeList(o.ops.mainlineNodeList(w.root));n.mode="play",n.loading=!1,n.round=void 0,n.voted=void 0,n.justPlayed=void 0,n.resultSent=!1,n.lastFeedback="init",n.initialPath=i,n.initialNode=w.nodeAtPath(i),q(o.path.init(i)),setTimeout((function(){$(i),t()}),500),n.canViewSolution=!1,setTimeout((function(){n.canViewSolution=!0,t()}),5e3),S=u.default(n,k.puzzle),M((function(e){e.setAutoShapes([]),e.setShapes([]),_(e)})),function(){y&&y.destroy();y=r.ctrl({redraw:t,storageKeyPrefix:"puzzle",multiPvDefault:3,variant:{short:"Std",name:"Standard",key:"standard"},possible:!0,emit:function(e,o){w.updateAt(o.path,(function(r){o.threatMode?(!r.threat||r.threat.depth<=e.depth||r.threat.maxDepth<e.maxDepth)&&(r.threat=e):(!r.ceval||r.ceval.depth<=e.depth||r.ceval.maxDepth<e.maxDepth)&&(r.ceval=e),o.path===n.path&&(I(),t())}))},setAutoShapes:I})}(),history.replaceState(null,"","/training/"+k.puzzle.id)}n.showComputer=()=>"view"===n.mode,n.showAutoShapes=()=>!0;var O=function(){const e=n.node,t=e.ply%2==0?"white":"black",o=i.readDests(e.dests),r="view"===n.mode||t===k.puzzle.color?{color:o&&Object.keys(o).length>0?t:void 0,dests:o||{}}:{color:void 0,dests:{}},a={fen:e.fen,orientation:k.puzzle.color,turnColor:t,movable:r,premovable:{enabled:!1},check:!!e.check,lastMove:A(e.uci)};return e.ply>=n.initialNode.ply&&(o||e.check?"view"!==n.mode&&t!==k.puzzle.color&&(a.movable.color=k.puzzle.color,a.premovable.enabled=!0):(a.turnColor=s.opposite(t),a.movable.color=t,a.premovable.enabled=!0)),n.cgConfig=a,a};function _(e){e.set(O()),n.node.dests||R()}function x(e,t,o){const r={orig:e,dest:t,fen:n.node.fen,path:n.path};o&&(r.promotion=o),X.sendAnaMove(r)}var R=m.default(800,(function(){!n.node.dests&&o.path.contains(n.path,n.initialPath)&&X.sendAnaDests({fen:n.node.fen,path:n.path})})),A=function(e){return e&&[e.substr(0,2),e.substr(2,2)]};function z(e,t){var n=w.nodeAtPath(e);n.children.sort((function(e,t){return"fail"===e.puzzle?1:"retry"===e.puzzle?1:"good"===e.puzzle?-1:0})),t&&n.children.forEach((function(t){z(e+t.id,!0)}))}var T=function(){setTimeout((function(){M((function(e){e.cancelPremove()})),U(o.path.init(n.path)),t()}),500)},D=function(e){"fail"===e?(n.lastFeedback="fail",T(),"play"===n.mode&&(n.canViewSolution=!0,n.mode="try",N(!1))):"retry"===e?(n.lastFeedback="retry",T()):"win"===e?"view"!==n.mode&&("play"===n.mode&&N(!0),n.lastFeedback="win",n.mode="view",M(_),j()):e&&e.orig&&(n.lastFeedback="good",setTimeout((function(){X.sendAnaMove(e)}),500))};function N(e){n.resultSent||(n.resultSent=!0,G(Math.max(0,parseInt(G())-1)),v.round(k.puzzle.id,e).then((function(o){k.user=o.user,n.round=o.round,n.voted=o.voted,t(),e&&g.success()})))}function I(){M((function(e){e.setAutoShapes(h.default({vm:n,ceval:y,ground:e,threatMode:C(),nextNodeBest:B()}))}))}function j(){y.enabled()&&"view"===n.mode&&!W()&&L()}const L=m.default(800,(function(){y.start(n.path,n.nodeList,C())}));function B(){return o.ops.withMainlineChild(n.node,(function(e){return e.eval?e.eval.best:void 0}))}function F(e){var t=i.decomposeUci(e);t[2]?x(t[0],t[1],i.sanToRole[t[2].toUpperCase()]):x(t[0],t[1])}function K(){return y}function V(){y.toggle(),I(),j(),y.enabled()||C(!1),n.autoScrollRequested=!0,t()}function H(){n.node.check||(y.enabled()||y.toggle(),y.enabled()&&(C(!C()),I(),j(),t()))}function W(){return""===n.node.dests&&(n.node.check?"checkmate":"draw")}function $(e){const t=e!==n.path,o=t&&e.length===n.path.length+2;q(e),M(_),t&&(o&&(n.node.uci?n.justPlayed&&!n.node.uci.includes(n.justPlayed)||(n.node.san.includes("x")?b.sound.capture():b.sound.move()):b.sound.move(),/\+|\#/.test(n.node.san)&&b.sound.check()),C(!1),y.stop(),j()),Z.cancel(),n.justPlayed=void 0,n.autoScrollRequested=!0,window.lichess.pubsub.emit("ply",n.node.ply)}function U(e){M((function(e){e.selectSquare(null)})),$(e),g.node(n.node,!0)}const X=c.default({send:e.socketSend,addNode:function(e,n){$(w.addNode(e,n)),z(n),t(),M((function(e){e.playPremove()}));var o=S();o&&D(o),t(),g.node(e,!1)},addDests:function(e,t,o){w.addDests(e,t,o),t===n.path&&(M(_),W()&&y.stop()),M((function(e){e.playPremove()}))},reset:function(){M(_),t()}}),G=f.storedProp("puzzle.vote-call",3);let Y;const Q=()=>parseInt(G())<1,J=m.default(1e3,(function(e){Q()&&(Y=Date.now()+2e3),G(5),n.voted=e,v.vote(k.puzzle.id,e).then((function(e){k.puzzle.vote=e[1],t()}))}));E(e.data);const Z=d.default(n,P,t);return a.default({vm:n,userJump:U,getCeval:K,toggleCeval:V,toggleThreatMode:H,redraw:t,playBestMove(){var e=B()||n.node.ceval&&n.node.ceval.pvs[0].moves[0];e&&F(e)}}),document.addEventListener("visibilitychange",(function(){window.lichess.requestIdleCallback((function(){$(n.path)}))})),g.setup(),{vm:n,getData:()=>k,getTree:()=>w,ground:P,makeCgOpts:O,userJump:U,viewSolution:function(){if(n.canViewSolution){N(!1),n.mode="view",l.default(n.initialNode,k.puzzle.branch,k.puzzle.color),z(n.initialPath,!0);var e=n.node.children[0];if(e&&"good"===e.puzzle)U(n.path+e.id);else{var r=o.ops.takePathWhile(n.mainline,(function(e){return"good"!==e.puzzle}));r&&U(r+w.nodeAtPath(r).children[0].id)}n.autoScrollRequested=!0,t(),j()}},nextPuzzle:function(){y.stop(),n.loading=!0,t(),v.nextPuzzle().done((function(e){n.round=null,n.loading=!1,E(e),t()}))},recentHash:function(){return"ph"+k.puzzle.id+(k.user?k.user.recent.reduce((function(e,t){return e+t[0]}),""):"")},callToVote:Q,thanks:()=>!!Y&&Date.now()<Y,vote:J,getCeval:K,pref:e.pref,trans:window.lichess.trans(e.i18n),socketReceive:X.receive,gameOver:W,toggleCeval:V,toggleThreatMode:H,threatMode:C,currentEvals:()=>({client:n.node.ceval}),nextNodeBest:B,userMove:function(e,t){n.justPlayed=e,Z.start(e,t,x)||x(e,t)},playUci:F,showEvalGauge:()=>n.showComputer()&&y.enabled(),getOrientation:()=>M((function(e){return e.state.orientation})),getNode:()=>n.node,showComputer:n.showComputer,promotion:Z,redraw:t,ongoing:!1}}},{"./autoShape":53,"./keyboard":56,"./moveTest":58,"./promotion":59,"./socket":60,"./solution":61,"./sound":62,"./speech":63,"./xhr":73,ceval:39,chess:44,"chessground/util":18,common:46,"common/storage":50,"common/throttle":52,tree:74}],56:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./control"),r=e=>t=>{t.preventDefault(),e()};n.default=function(e){if(!window.Mousetrap)return;const t=window.Mousetrap;t.bind(["left","k"],r((function(){o.prev(e),e.redraw()}))),t.bind(["right","j"],r((function(){o.next(e),e.redraw()}))),t.bind(["up","0"],r((function(){o.first(e),e.redraw()}))),t.bind(["down","$"],r((function(){o.last(e),e.redraw()}))),t.bind("l",r(e.toggleCeval)),t.bind("x",r(e.toggleThreatMode)),t.bind("space",r((function(){"view"===e.vm.mode&&(e.getCeval().enabled()?e.playBestMove():e.toggleCeval())})))}},{"./control":54}],57:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./ctrl"),r=e("./view/main"),i=e("chessground"),s=e("snabbdom"),a=e("snabbdom/modules/class"),c=e("snabbdom/modules/attributes");e("common/menuHover").menuHover();const u=s.init([a.default,c.default]);n.default=function(e){let t,n;n=o.default(e,(function(){t=u(t,r.default(n))}));const i=r.default(n);return e.element.innerHTML="",t=u(e.element,i),{socketReceive:n.socketReceive}},window.Chessground=i.Chessground},{"./ctrl":55,"./view/main":70,chessground:5,"common/menuHover":48,snabbdom:35,"snabbdom/modules/attributes":33,"snabbdom/modules/class":34}],58:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("tree"),r=e("chess"),i={e1a1:"e1c1",e1h1:"e1g1",e8a8:"e8c8",e8h8:"e8g8"};n.default=function(e,t){return function(){if("view"!==e.mode&&(o.path.contains(e.path,e.initialPath)&&(e.node.ply%2==1?"white":"black")===t.color)){var n=e.nodeList.slice(o.path.size(e.initialPath)+1).map((function(e){return{uci:e.uci,castle:e.san.startsWith("O-O")}})),s=t.lines;for(var a in n)if("string"==typeof(s=s[n[a].uci]?s[n[a].uci]:n[a].castle&&s[i[n[a].uci]]||"fail"))break;if("string"==typeof s)return e.node.puzzle=s,s;var c=Object.keys(s)[0];if("win"===s[c])return e.node.puzzle="win","win";e.node.puzzle="good";var u=r.decomposeUci(c),l=u[2]?r.sanToRole[u[2].toUpperCase()]:null,d={orig:u[0],dest:u[1],fen:e.node.fen,path:e.path};return l&&(d.promotion=l),d}}}},{chess:44,tree:74}],59:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=e("./util"),i=e("chessground/util");n.default=function(e,t,n){let s=!1;function a(){s&&(s=!1,t().set(e.cgConfig),n())}function c(e,n,c,u){if(!s)return;let l=12.5*(8-i.key2pos(e)[0]);"white"===u&&(l=87.5-l);const d=c===u?"top":"bottom";return o.h("div#promotion-choice."+d,{hook:r.onInsert(e=>{e.addEventListener("click",a),e.oncontextmenu=()=>!1})},n.map((function(e,n){const i=12.5*(c===u?n:7-n);return o.h("square",{attrs:{style:"top: "+i+"%;left: "+l+"%"},hook:r.bind("click",n=>{n.stopPropagation(),function(e){s&&function(e,t,n){var o={},r=e.state.pieces[t];r&&"pawn"==r.role&&(o[t]={color:r.color,role:n,promoted:!0},e.setPieces(o))}(t(),s.dest,e),s.callback&&s.callback(s.orig,s.dest,e),s=!1}(e)})},[o.h("piece."+e+"."+c)])})))}return{start:function(e,o,r){const i=t(),a=i.state.pieces[o];return!(!a||"pawn"!=a.role||!(8==o[1]&&"black"==i.state.turnColor||1==o[1]&&"white"==i.state.turnColor))&&(s={orig:e,dest:o,callback:r},n(),!0)},cancel:a,view(){if(!s)return;return c(s.dest,["queen","knight","rook","bishop"],i.opposite(t().state.turnColor),t().state.orientation)}}}},{"./util":64,"chessground/util":18,snabbdom:35}],60:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e){var t,n,o={},r={node:function(n){clearTimeout(t),e.addNode(n.node,n.path)},stepFailure:function(){clearTimeout(t),e.reset()},dests:function(t){o[t.path]=t,e.addDests(t.dests,t.path,t.opening),clearTimeout(n)},destsFailure:function(e){console.log(e),clearTimeout(n)}},i=function(n){clearTimeout(t),e.send("anaMove",n),t=setTimeout((function(){i(n)}),3e3)},s=function(t){clearTimeout(n),o[t.path]?setTimeout((function(){r.dests(o[t.path])}),10):(e.send("anaDests",t),n=setTimeout((function(){s(t)}),3e3))};return{send:e.send,receive:function(e,t){return!!r[e]&&(r[e](t),!0)},sendAnaMove:i,sendAnaDests:s}}},{}],61:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("tree");n.default=function(e,t,n){o.ops.updateAll(t,(function(e){"white"===n==(e.ply%2==1)&&(e.puzzle="good")}));const r=o.ops.childById(e,t.id);r?o.ops.merge(r,t):e.children.push(t)}},{tree:74}],62:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("common/throttle"),r=window.lichess.sound;n.sound={move:o.default(50,r.move),capture:o.default(50,r.capture),check:o.default(50,r.check)}},{"common/throttle":52}],63:[function(e,t,n){"use strict";function o(e){!window.LichessSpeech&&e?window.lichess.loadScript(window.lichess.compiledScript("speech")):window.LichessSpeech&&!e&&(window.LichessSpeech=void 0)}function r(e){window.LichessSpeech&&e(window.LichessSpeech)}Object.defineProperty(n,"__esModule",{value:!0}),n.setup=function(){window.lichess.pubsub.on("speech.enabled",o),o(window.lichess.sound.speech())},n.node=function(e,t){r(n=>n.step(e,t))},n.success=function(){r(e=>e.say("Success!",!1))}},{}],64:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom");function r(e){return{insert:t=>e(t.elm)}}n.bindMobileMousedown=function(e,t,n){for(const o of["touchstart","mousedown"])e.addEventListener(o,e=>{t(e),e.preventDefault(),n&&n()})},n.bind=function(e,t,n){return r(o=>o.addEventListener(e,e=>{const o=t(e);return n&&n(),o}))},n.onInsert=r,n.dataIcon=function(e){return{"data-icon":e}},n.spinner=function(){return o.h("div.spinner",[o.h("svg",{attrs:{viewBox:"0 0 40 40"}},[o.h("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])])}},{snabbdom:35}],65:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=e("../util");function i(e){var t=e.getData();if(t.puzzle.enabled)return o.h("div.vote",[o.h("a",{attrs:{"data-icon":"S",title:e.trans.noarg("thisPuzzleIsCorrect")},class:{active:!0===e.vm.voted},hook:r.bind("click",()=>e.vote(!0))}),o.h("span.count",{attrs:{title:"Popularity"}},""+Math.max(0,t.puzzle.vote)),o.h("a",{attrs:{"data-icon":"R",title:e.trans.noarg("thisPuzzleIsWrong")},class:{active:!1===e.vm.voted},hook:r.bind("click",()=>e.vote(!1))})])}n.default=function(e){const t=e.getData(),n=!!t.user&&e.callToVote()&&t.puzzle.enabled&&void 0===t.voted;return o.h("div.puzzle__feedback.after"+(n?".call":""),[n?o.h("div.vote_call",[o.h("strong",e.trans("wasThisPuzzleAnyGood")),o.h("br"),o.h("span",e.trans("pleaseVotePuzzle"))]):e.thanks()?o.h("div.vote_call",o.h("strong",e.trans("thankYou"))):null,o.h("div.half.half-top",["win"===e.vm.lastFeedback?o.h("div.complete.feedback.win",o.h("div.player",[o.h("div.icon",""),o.h("div.instruction",e.trans.noarg("success"))])):o.h("div.complete","Puzzle complete!"),t.user?i(e):null]),o.h("a.half.continue",{hook:r.bind("click",e.nextPuzzle)},[o.h("i",{attrs:r.dataIcon("G")}),e.trans.noarg("continueTraining")])])}},{"../util":64,snabbdom:35}],66:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=e("chessground"),i=e("common/resize");n.default=function(e){return o.h("div.cg-wrap",{hook:{insert:t=>e.ground(r.Chessground(t.elm,function(e){const t=e.makeCgOpts();return{fen:t.fen,orientation:t.orientation,turnColor:t.turnColor,check:t.check,lastMove:t.lastMove,coordinates:0!==e.pref.coords,addPieceZIndex:e.pref.is3d,movable:{free:!1,color:t.movable.color,dests:t.movable.dests,showDests:e.pref.destination,rookCastle:e.pref.rookCastle},draggable:{enabled:e.pref.moveEvent>0,showGhost:e.pref.highlight},selectable:{enabled:1!==e.pref.moveEvent},events:{move:e.userMove,insert(t){i.default(t,e.pref.resizeHandle,e.vm.node.ply,e=>!0)}},premovable:{enabled:t.premovable.enabled},drawable:{enabled:!0},highlight:{lastMove:e.pref.highlight,check:e.pref.highlight},animation:{enabled:!0,duration:e.pref.animation.duration},disableContextMenu:!0}}(e))),destroy:t=>e.ground().destroy()}})}},{chessground:5,"common/resize":49,snabbdom:35}],67:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=e("./after"),i=e("../util");function s(e){return o.h("div.view_solution",{class:{show:e.vm.canViewSolution}},[o.h("a.button.button-empty",{hook:i.bind("click",e.viewSolution)},e.trans.noarg("viewTheSolution"))])}n.default=function(e){return e.vm.loading?o.h("div.puzzle__feedback.loading",i.spinner()):"view"===e.vm.mode?r.default(e):"init"===e.vm.lastFeedback?function(e){var t=e.getData().puzzle.color;return o.h("div.puzzle__feedback.play",[o.h("div.player",[o.h("div.no-square",o.h("piece.king."+t)),o.h("div.instruction",[o.h("strong",e.trans.noarg("yourTurn")),o.h("em",e.trans.noarg("white"===t?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]),s(e)])}(e):"good"===e.vm.lastFeedback?function(e){return o.h("div.puzzle__feedback.good",[o.h("div.player",[o.h("div.icon",""),o.h("div.instruction",[o.h("strong",e.trans.noarg("bestMove")),o.h("em",e.trans.noarg("keepGoing"))])]),s(e)])}(e):"retry"===e.vm.lastFeedback?function(e){return o.h("div.puzzle__feedback.retry",[o.h("div.player",[o.h("div.icon","!"),o.h("div.instruction",[o.h("strong",e.trans.noarg("goodMove")),o.h("em",e.trans.noarg("butYouCanDoBetter"))])]),s(e)])}(e):"fail"===e.vm.lastFeedback?function(e){return o.h("div.puzzle__feedback.fail",[o.h("div.player",[o.h("div.icon",""),o.h("div.instruction",[o.h("strong",e.trans.noarg("puzzleFailed")),o.h("em",e.trans.noarg("butYouCanKeepTrying"))])]),s(e)])}(e):void 0}},{"../util":64,"./after":65,snabbdom:35}],68:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("common/gridHacks");n.start=function(e){if(!o.needsBoardHeightFix())return;const t=()=>o.fixMainBoardHeight(e);o.runner(t),o.bindChessgroundResizeOnce(t)}},{"common/gridHacks":47}],69:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=15;function i(e){const t=e.getData(),n=[];for(let o=0;o<r;o++)n[o]=t.user.recent[o]||null;return o.h("div.puzzle__history",n.map((function(e){if(e)return o.h("a",{class:{current:t.puzzle.id===e[0],win:e[1]>=0,loss:e[1]<0},attrs:{href:"/training/"+e[0]}},e[1]>0?"+"+e[1]:""+-e[1])})))}n.default=function(e){if(e.getData().user)return o.thunk("div.puzzle__history",i,[e,e.recentHash()])}},{snabbdom:35}],70:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=e("./chessground"),i=e("./tree"),s=e("ceval"),a=e("../control"),c=e("./feedback"),u=e("./history"),l=e("./side"),d=e("./gridHacks"),h=e("../util");function p(e){var t=e.getTree().getOpening(e.vm.nodeList);if(t)return o.h("div.opening_box",{attrs:{title:t.eco+" "+t.name}},[o.h("strong",t.eco)," "+t.name])}function f(e){return o.h("div.puzzle__moves.areplay",[p(e),i.render(e)])}function m(e,t){return o.h("button.fbt",{attrs:{"data-act":t,"data-icon":e}})}function v(e){return o.h("div.puzzle__controls.analyse-controls",{hook:h.onInsert(t=>{h.bindMobileMousedown(t,t=>{const n=function(e){return e.target.getAttribute("data-act")||e.target.parentNode.getAttribute("data-act")}(t);"prev"===n?a.prev(e):"next"===n?a.next(e):"first"===n?a.first(e):"last"===n&&a.last(e)},e.redraw)})},[o.h("div.jumps",[m("W","first"),m("Y","prev"),m("X","next"),m("V","last")])])}let g=!1;n.default=function(e){const t=e.vm.showComputer(),n=e.showEvalGauge();return g!==t&&(g||(e.vm.autoScrollNow=!0),g=t),o.h("main.puzzle",{class:{"gauge-on":n},hook:{postpatch(t,o){d.start(o.elm),t.data.gaugeOn!==n&&(2==e.pref.coords&&$("body").toggleClass("coords-in",n).toggleClass("coords-out",!n),window.lichess.dispatchEvent(document.body,"chessground.resize")),o.data.gaugeOn=n}}},[o.h("aside.puzzle__side",[l.puzzleBox(e),l.userBox(e)]),o.h("div.puzzle__board.main-board"+(e.pref.blindfold?".blindfold":""),{hook:window.lichess.hasTouchEvents?void 0:h.bind("wheel",t=>(function(e,t){const n=t.target;if("PIECE"===n.tagName||"SQUARE"===n.tagName||"CG-BOARD"===n.tagName)return t.preventDefault(),t.deltaY>0?a.next(e):t.deltaY<0&&a.prev(e),e.redraw(),!1})(e,t))},[r.default(e),e.promotion.view()]),s.view.renderGauge(e),o.h("div.puzzle__tools",[o.h("div.ceval-wrap",{class:{none:!t}},t?[s.view.renderCeval(e),s.view.renderPvs(e)]:[]),f(e),c.default(e)]),v(e),u.default(e)])}},{"../control":54,"../util":64,"./chessground":66,"./feedback":67,"./gridHacks":68,"./history":69,"./side":71,"./tree":72,ceval:39,snabbdom:35}],71:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=e("../util");function i(e,t){return o.h("div.infos.puzzle",{attrs:r.dataIcon("-")},[o.h("div",[o.h("a.title",{attrs:{href:"/training/"+t.id}},e.trans("puzzleId",t.id)),o.h("p",e.trans.vdom("ratingX","play"===e.vm.mode?o.h("span.hidden",e.trans.noarg("hidden")):o.h("strong",t.rating))),o.h("p",e.trans.vdom("playedXTimes",o.h("strong",window.lichess.numberFormat(t.attempts))))])])}function s(e,t,n){return o.h("div.infos",{attrs:r.dataIcon(t.perf.icon)},[o.h("div",[o.h("p",e.trans.vdom("fromGameLink",o.h("a",{attrs:{href:`/${t.id}/${n.color}#${n.initialPly}`}},"#"+t.id))),o.h("p",[t.clock,"  ",t.perf.name,"  ",e.trans.noarg(t.rated?"rated":"casual")]),o.h("div.players",t.players.map((function(e){return o.h("div.player.color-icon.is.text."+e.color,e.userId?o.h("a.user-link.ulpt",{attrs:{href:"/@/"+e.userId}},e.name):e.name)})))])])}function a(e,t){return o.h("div.rating_chart."+t,{hook:{insert(t){c(e,t)},postpatch(t,n){c(e,n)}}})}function c(e,t){const n=$(t.elm),o=document.body.classList.contains("dark"),r=e.getData().user.recent.map((function(e){return e[2]+e[1]})),i=()=>n.sparkline(r,{type:"line",width:Math.round(n.outerWidth())+"px",height:"80px",lineColor:o?"#4444ff":"#0000ff",fillColor:o?"#222255":"#ccccff",numberFormatter:e=>e});window.lichess.raf(i),window.addEventListener("resize",i)}n.puzzleBox=function(e){var t=e.getData();return o.h("div.puzzle__side__metas",[i(e,t.puzzle),s(e,t.game,t.puzzle)])},n.userBox=function(e){const t=e.getData();if(!t.user)return;const n=e.vm.round&&e.vm.round.ratingDiff,r=e.recentHash();return o.h("div.puzzle__side__user",[o.h("h2",e.trans.vdom("yourPuzzleRatingX",o.h("strong",[t.user.rating,...n>0?[" ",o.h("good.rp","+"+n)]:[],...n<0?[" ",o.h("bad.rp",""+-n)]:[]]))),o.h("div",o.thunk("div.rating_chart."+r,a,[e,r]))])}},{"../util":64,snabbdom:35}],72:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("snabbdom"),r=e("common"),i=e("common/throttle"),s=e("chess"),a=e("tree"),c=i.default(150,(e,t)=>{var n=t.parentNode,o=t.querySelector(".active");n.scrollTop=o?o.offsetTop-n.offsetHeight/2+o.offsetHeight:e.vm.path===a.path.root?0:99999});function u(e,t){return a.path.contains(e.ctrl.vm.path,t)}function l(e,t){return o.h("index",function(e){return Math.floor((e-1)/2)+1}(e)+(t?e%2==1?".":"...":""))}function d(e,t,n){const r=t.children,i=r[0];if(!i)return[];if(n.isMainline){const t=i.ply%2==1;if(!r[1])return[t?l(i.ply,!1):null,...g(e,i,{parentPath:n.parentPath,isMainline:!0})];const s=d(e,i,{parentPath:n.parentPath+i.id,isMainline:!0}),a={parentPath:n.parentPath,isMainline:!0};return[t?l(i.ply,!1):null,p(e,i,a),t?b():null,o.h("interrupt",h(e,r.slice(1),{parentPath:n.parentPath,isMainline:!0})),...t&&s?[l(i.ply,!1),b()]:[],...s]}return r[1]?[h(e,r,n)]:g(e,i,n)}function h(e,t,n){return o.h("lines",{class:{single:!!t[1]}},t.map((function(t){return o.h("line",g(e,t,{parentPath:n.parentPath,isMainline:!1,withIndex:!0}))})))}function p(e,t,n){return n.isMainline?function(e,t,n){const r=n.parentPath+t.id,i={active:r===e.ctrl.vm.path,current:r===e.ctrl.vm.initialPath,hist:t.ply<e.ctrl.vm.initialNode.ply};t.puzzle&&(i[t.puzzle]=!0);return o.h("move",{attrs:{p:r},class:i},v(e,t))}(e,t,n):function(e,t,n){const r=n.withIndex||t.ply%2==1,i=n.parentPath+t.id,s=i===e.ctrl.vm.path,a={active:s,parent:!s&&u(e,i)};t.puzzle&&(a[t.puzzle]=!0);return o.h("move",{attrs:{p:i},class:a},[r?l(t.ply,!0):null,t.san,m(e,t)])}(e,t,n)}function f(e){return o.h("glyph",{attrs:{title:e.name}},e.symbol)}function m(e,t){switch(t.puzzle){case"good":case"win":return f({name:e.ctrl.trans.noarg("bestMove"),symbol:""});case"fail":return f({name:e.ctrl.trans.noarg("puzzleFailed"),symbol:""});case"retry":return f({name:e.ctrl.trans.noarg("goodMove"),symbol:"?!"})}}function v(e,t){const n=t.eval||t.ceval||{};return[t.san,r.defined(n.cp)?k(s.renderEval(n.cp)):r.defined(n.mate)?k("#"+n.mate):null,m(e,t)]}function g(e,t,n){return[p(e,t,n),...d(e,t,{parentPath:n.parentPath+t.id,isMainline:n.isMainline})]}function b(){return o.h("move.empty","...")}function k(e){return o.h("eval",e)}n.renderIndex=l,n.renderMove=v,n.render=function(e){const t=e.getTree().root,n={ctrl:e,showComputer:!1};return o.h("div.tview2.tview2-column",{hook:{insert:t=>{const n=t.elm;e.path!==a.path.root&&c(e,n),n.addEventListener("mousedown",t=>{if(r.defined(t.button)&&0!==t.button)return;const n=function(e){return e.target.getAttribute("p")||e.target.parentNode.getAttribute("p")}(t);n&&e.userJump(n),e.redraw()})},postpatch:(t,n)=>{e.vm.autoScrollNow?(c(e,n.elm),e.vm.autoScrollNow=!1,e.autoScrollRequested=!1):e.vm.autoScrollRequested&&(e.vm.path!==a.path.root&&c(e,n.elm),e.vm.autoScrollRequested=!1)}}},[...t.ply%2==1?[l(t.ply,!1),b()]:[],...d(n,t,{parentPath:"",isMainline:!0})])}},{chess:44,common:46,"common/throttle":52,snabbdom:35,tree:74}],73:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.round=function(e,t){return $.ajax({method:"POST",url:"/training/"+e+"/round2",data:{win:t?1:0}})},n.vote=function(e,t){return $.ajax({method:"POST",url:"/training/"+e+"/vote",data:{vote:t?1:0}})},n.nextPuzzle=function(){return $.ajax({url:"/training/new"})}},{}],74:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./tree");n.build=o.build;const r=e("./path");n.path=r;const i=e("./ops");n.ops=i},{"./ops":75,"./path":76,"./tree":77}],75:[function(e,t,n){"use strict";function o(e,t){const n=e.children[0];return n?t(n):void 0}function r(e,t){let n,o=[e],r=e;for(;n=t(r);)o.push(n),r=n;return o}function i(e){return e.children[0]}function s(e,t){return e.children.find(e=>e.id===t)}Object.defineProperty(n,"__esModule",{value:!0}),n.withMainlineChild=o,n.findInMainline=function(e,t){const n=function(e){return t(e)?e:o(e,n)};return n(e)},n.collect=r,n.childById=s,n.last=function(e){return e[e.length-1]},n.nodeAtPly=function(e,t){return e.find(e=>e.ply===t)},n.takePathWhile=function(e,t){let n="";for(let o in e){if(!t(e[o]))break;n+=e[o].id}return n},n.removeChild=function(e,t){e.children=e.children.filter((function(e){return e.id!==t}))},n.countChildrenAndComments=function e(t){const n={nodes:1,comments:(t.comments||[]).length};return t.children.forEach((function(t){const o=e(t);n.nodes+=o.nodes,n.comments+=o.comments})),n},n.reconstruct=function(e){const t=e[0],n=e.length;let o,r=t;for(t.id="",o=1;o<n;o++){const t=e[o];r.children?r.children.unshift(t):r.children=[t],r=t}return r.children=r.children||[],t},n.merge=function e(t,n){t.eval=n.eval,n.glyphs&&(t.glyphs=n.glyphs),n.comments&&n.comments.forEach((function(e){t.comments?t.comments.filter((function(t){return t.text===e.text})).length||t.comments.push(e):t.comments=[e]})),n.children.forEach((function(n){const o=s(t,n.id);o?e(o,n):t.children.push(n)}))},n.hasBranching=function e(t,n){return n<=0||!!t.children[1]||t.children[0]&&e(t.children[0],n-1)},n.mainlineNodeList=function(e){return r(e,i)},n.updateAll=function(e,t){!function e(n){t(n),n.children.forEach(e)}(e)}},{}],76:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.root="",n.size=function(e){return e.length/2},n.head=function(e){return e.slice(0,2)},n.tail=function(e){return e.slice(2)},n.init=function(e){return e.slice(0,-2)},n.last=function(e){return e.slice(-2)},n.contains=function(e,t){return e.startsWith(t)},n.fromNodeList=function(e){var t="";for(var n in e)t+=e[n].id;return t},n.isChildOf=function(e,t){return!!e&&e.slice(0,-2)===t}},{}],77:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./path"),r=e("./ops"),i=e("common");n.build=function(e){function t(t){return function e(t,n){if(""===n)return t;const i=r.childById(t,o.head(n));return i?e(i,o.tail(n)):t}(e,t)}function n(t){return function e(t,n){if(""===n)return t;const i=r.childById(t,o.head(n));return i?e(i,o.tail(n)):void 0}(e,t)}function s(t){return r.collect(e,(function(e){const n=o.head(t);if(""!==n)return t=o.tail(t),r.childById(e,n)}))}function a(e,t){const o=n(e);if(o)return t(o),o}function c(e,t){const o=t+e.id,r=n(o);return r?(["dests","drops","clock"].forEach(t=>{i.defined(e[t])&&!i.defined(r[t])&&(r[t]=e[t])}),o):a(t,(function(t){t.children.push(e)}))?o:void 0}function u(e,t){return a(t,(function(t){var n=(t.comments||[]).filter((function(t){return t.id!==e}));t.comments=n.length?n:void 0}))}function l(e){return t(o.init(e))}return{root:e,lastPly:()=>r.findInMainline(e,(function(e){return!e.children.length})).ply,nodeAtPath:t,getNodeList:s,longestValidPath:t=>(function e(t,n){var i=o.head(n);const s=r.childById(t,i);return s?i+e(s,o.tail(n)):""})(e,t),getOpening:function(e){var t;return e.forEach((function(e){t=e.opening||t})),t},updateAt:a,addNode:c,addNodes:function e(t,n){var o=t[0];if(!o)return n;const r=c(o,n);return r?e(t.slice(1),r):void 0},addDests:(e,t,n)=>a(t,(function(t){t.dests=e,n&&(t.opening=n)})),setShapes:(e,t)=>a(t,(function(t){t.shapes=e})),setCommentAt:function(e,t){return e.text?a(t,(function(t){t.comments=t.comments||[];const n=t.comments.find((function(t){return t.id===e.id}));n?n.text=e.text:t.comments.push(e)})):u(e.id,t)},deleteCommentAt:u,setGlyphsAt:function(e,t){return a(t,(function(t){t.glyphs=e}))},setClockAt:(e,t)=>a(t,(function(t){t.clock=e})),pathIsMainline:function(t){return function e(t,n){if(""===n)return!0;const r=o.head(n),i=t.children[0];return!(!i||i.id!==r)&&e(i,o.tail(n))}(e,t)},pathIsForcedVariation:function(e){return!!s(e).find(e=>e.forceVariation)},lastMainlineNode:t=>(function e(t,n){if(""===n)return t;const r=o.head(n),i=t.children[0];return i&&i.id===r?e(i,o.tail(n)):t})(e,t),pathExists:function(e){return!!n(e)},deleteNodeAt:function(e){r.removeChild(l(e),o.last(e))},promoteAt:function(e,t){for(var n=s(e),o=n.length-2;o>=0;o--){var i=n[o+1],a=n[o];if(a.children[0].id!==i.id){if(r.removeChild(a,i.id),a.children.unshift(i),!t)break}else if(i.forceVariation&&(i.forceVariation=!1,!t))break}},forceVariationAt:(e,t)=>a(e,(function(e){e.forceVariation=t})),getCurrentNodesAfterPly:function(e,t,n){var o,r=[];for(var i in e){if((o=e[i]).ply<=n&&t[i].id!==o.id)break;o.ply>n&&r.push(o)}return r},merge(t){r.merge(e,t)},removeCeval(){r.updateAll(e,(function(e){delete e.ceval,delete e.threat}))},removeComputerVariations(){r.mainlineNodeList(e).forEach((function(e){e.children=e.children.filter((function(e){return!e.comp}))}))},parentNode:l,getParentClock:function(e,t){if(!("parentClock"in e)){const n=t&&l(t);e.parentClock=n?"clock"in n?n.clock:void 0:e.clock}return e.parentClock}}}},{"./ops":75,"./path":76,common:46}]},{},[57])(57)}));
